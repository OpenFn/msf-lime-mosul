id: wf1-dhis2-omrs-migration
name: wf1-dhis2-omrs-migration
start: cron
options: {}
steps:
  - id: alert-admin-of-duplicate-teis
    name: Alert Admin of Duplicate TEIs
    adaptor: "@openfn/language-common@2.1.1"
    expression: ./alert-admin-of-duplicate-teis.js
  - id: create-patients
    name: Create Patients
    adaptor: "@openfn/language-openmrs@4.2.0"
    configuration: a3d3dca3-6afa-4697-8a70-dbccfa41b013
    expression: ./create-patients.js
    next:
      update-teis:
        disabled: false
        condition: on_job_success
  - id: cron
    type: cron
    next:
      fetch-metadata:
        disabled: false
        condition: always
  - id: fetch-metadata
    name: Fetch Metadata
    adaptor: "@openfn/language-common@2.1.1"
    configuration: 85712d34-82e4-4558-998d-b399891d488f
    expression: ./fetch-metadata.js
    next:
      get-teis-and-locations:
        disabled: false
        condition: on_job_success
  - id: get-teis-and-locations
    name: Get Teis and Locations
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./get-teis-and-locations.js
    next:
      create-patients:
        disabled: false
        condition: |
          state.uniqueTeis.length > 0 && !state.errors
        name: has-teis
      validate-teis-with-omrs-id:
        disabled: false
        condition: |
          !state.errors && state. teisWithOMRSID.length > 0
        name: has-teisWithOMRSID
      alert-admin-of-duplicate-teis:
        disabled: false
        condition: |
          state.duplicatePatients.length > 0 && !state.errors
        name: has-duplicate-patients
  - id: update-teis
    name: Update Teis
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./update-teis.js
  - id: validate-teis-with-omrs-id
    name: Validate TEIs with OMRS Id
    adaptor: "@openfn/language-openmrs@4.2.0"
    configuration: a3d3dca3-6afa-4697-8a70-dbccfa41b013
    expression: ./validate-teis-with-omrs-id.js
