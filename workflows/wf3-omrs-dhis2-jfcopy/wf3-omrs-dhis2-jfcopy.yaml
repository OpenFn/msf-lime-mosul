id: wf3-omrs-dhis2-jfcopy
name: wf3-omrs-dhis2-jfcopy
start: cron
options: {}
steps:
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    expression: ./create-events.js
  - id: cron
    type: cron
    enabled: false
    next:
      get-patients:
        disabled: false
        condition: always
  - id: custom-logic-for-events
    name: Custom Logic for Events
    adaptor: "@openfn/language-common@2.1.1"
    expression: ./custom-logic-for-events.js
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors && !state.testMode
        label: has-events
      populate-outcomes-in-test-suite:
        disabled: false
        condition: "!state.errors && state.testMode"
        label: is-test
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: mtuchi@openfn.org|OpenMRS Demo
    expression: ./get-encounters.js
    next:
      get-teis-and-map-answers:
        disabled: false
        condition: |
          !state.errors && state?.encountersPatientUuids?.length > 0
        label: has-encounters
  - id: get-mappings-from-collection
    name: Get Mappings from Collection
    adaptor: "@openfn/language-common@3.2.2"
    configuration: mtuchi@openfn.org|mtuchi-collections-config
    expression: ./get-mappings-from-collection.js
    next:
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        label: has-no-patients
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        label: has-patients
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: mtuchi@openfn.org|OpenMRS Demo
    expression: ./get-patients.js
    next:
      get-mappings-from-collection:
        disabled: false
        condition: on_job_success
  - id: get-teis-and-map-answers
    name: Get TEIs and Map Answers
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: mtuchi@openfn.org|MSF DHIS2 UAT
    expression: ./get-teis-and-map-answers.js
    next:
      custom-logic-for-events:
        disabled: false
        condition: |
          state.TEIs && !state.errors
        label: has-teis
  - id: populate-outcomes-in-test-suite
    name: Populate Outcomes in Test Suite
    adaptor: "@openfn/language-googlesheets@4.0.8"
    configuration: justin@openfn.org|Justin-GSheets-Sandbox
    expression: ./populate-outcomes-in-test-suite.js
  - id: prepare-tests
    name: Prepare Tests
    adaptor: "@openfn/language-common@3.2.2"
    expression: ./prepare-tests.js
    next:
      get-patients:
        disabled: false
        condition: on_job_success
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: mtuchi@openfn.org|MSF DHIS2 UAT
    expression: ./upsert-teis.js
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        label: has-patient-uuids
  - id: webhook
    type: webhook
    enabled: true
    next:
      prepare-tests:
        disabled: false
        condition: always
