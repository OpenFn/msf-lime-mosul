id: wf3-omrs-dhis2-143
name: wf3-omrs-dhis2-143
options: {}
steps:
  - id: trigger
    type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: fae8a456-2b7f-4e2d-88b3-663c0172af92
  - id: get-mappings-from-collection
    name: Get Mappings from Collection
    adaptor: "@openfn/language-common@2.3.0"
    next:
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: 04ef3440-9849-46eb-8bff-9806e5567aae
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: 4ed7f752-f415-498a-8512-40a9e6d8a837
    expression: ./get-mappings-from-collection.js
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      get-teis-and-map-answers:
        disabled: false
        condition: |
          !state.errors && state?.encounters?.length > 0
        openfn:
          uuid: d144977a-ba5c-4eb7-899a-7cb80f40131d
    expression: ./get-encounters.js
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    expression: ./create-events.js
  - id: custom-logic-for-events
    name: Custom Logic for Events
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors && !state.testMode
        openfn:
          uuid: e9c01f8e-2b0d-454e-8a69-3914d6648a08
    expression: ./custom-logic-for-events.js
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      get-mappings-from-collection:
        disabled: false
        openfn:
          uuid: e0143ebf-688e-4207-8a23-763660635079
    expression: ./get-patients.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: 2584c541-a282-487c-89db-4c772a93e9fd
    expression: ./upsert-teis.js
  - id: get-teis-and-map-answers
    name: Get TEIs and Map Answers
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      custom-logic-for-events:
        disabled: false
        condition: |
          state.TEIs && !state.errors
        openfn:
          uuid: 31164d27-0a83-4c0b-8a14-07d07d3e5247
    expression: ./get-teis-and-map-answers.js
  - id: get-tie
    name: Get Tie
    adaptor: "@openfn/language-dhis2@7.1.3"
    next:
      custom-logic-for-events:
        disabled: false
        condition: |
          state.testMode
        openfn:
          uuid: 2f6a896d-8ba5-4f94-8a8f-56175586aa09
    expression: ./get-tie.js
