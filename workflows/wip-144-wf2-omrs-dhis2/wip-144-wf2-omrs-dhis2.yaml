id: wip-144-wf2-omrs-dhis2
name: "[WIP-144]wf2-omrs-dhis2"
options: {}
steps:
  - id: trigger
    type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: 5539ce53-953a-41e0-898b-d07d2d8006a4
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      mappings:
        disabled: false
        openfn:
          uuid: dee4c54f-fe7e-4581-859d-ee16c419d541
    expression: ./get-patients.js
  - id: mappings
    name: Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: ad184870-3512-4895-88b3-26185ab794e3
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: 0b310ac7-5601-431b-8ea6-58d489c1a5ec
    expression: ./mappings.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: 9e96df13-cbb1-40b6-83ee-0e60feab43d3
    expression: ./upsert-teis.js
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      get-parent-and-child-teis:
        disabled: false
        condition: |
          !state.errors && state.encounters.length > 0
        openfn:
          uuid: b2c3b263-3958-4f9a-825e-fee1ff365d8c
    expression: ./get-encounters.js
  - id: get-parent-and-child-teis
    name: Get Parent and Child TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      upsert-child-teis:
        disabled: false
        condition: >
          Object.keys(state?.childTeis)?.length > 0 &&
          Object.keys(state?.parentTeis)?.length > 0
        openfn:
          uuid: c61709e1-b3c4-48af-86ac-9cb8e1a65ad3
    expression: ./get-parent-and-child-teis.js
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      update-teis:
        disabled: false
        condition: |
          state?.teisToUpdate?.length > 0
        openfn:
          uuid: b67eb7f6-d1f2-4d7f-8014-5291d8161914
    expression: ./create-events.js
  - id: update-teis
    name: Update TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    expression: ./update-teis.js
  - id: event-mappings
    name: Event Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors
        openfn:
          uuid: f5d57fa1-9b0a-4272-8c4a-a2ed88380265
    expression: ./event-mappings.js
  - id: create-teis-relationship
    name: Create TEIs Relationship
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      event-mappings:
        disabled: false
        condition: |
          state.childTeis && !state.errors
        openfn:
          uuid: 9a6f0f68-33e2-4ab1-8b49-ce43a69cb9f4
    expression: ./create-teis-relationship.js
  - id: upsert-child-teis
    name: Upsert Child TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      create-teis-relationship:
        disabled: false
        openfn:
          uuid: 0dbd169e-bc96-48cb-89e7-2030b66e7983
    expression: ./upsert-child-teis.js
