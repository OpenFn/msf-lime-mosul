id: wf2-omrs-dhis2
name: wf2-omrs-dhis2
start: cron
options: {}
steps:
  - id: create-child-teis
    name: Create Child TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./create-child-teis.js
    next:
      create-teis-relationship:
        disabled: false
        condition: on_job_success
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./create-events.js
    next:
      update-teis:
        disabled: false
        condition: |
          state?.teisToUpdate?.length > 0
        name: has-gender-updated
  - id: create-teis-relationship
    name: Create TEIs Relationship
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./create-teis-relationship.js
    next:
      event-mappings:
        disabled: false
        condition: on_job_success
  - id: cron
    type: cron
    next:
      get-patients:
        disabled: false
        condition: always
  - id: event-mappings
    name: Event Mappings
    adaptor: "@openfn/language-common@2.1.1"
    expression: ./event-mappings.js
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors
        name: has-events
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: a3d3dca3-6afa-4697-8a70-dbccfa41b013
    expression: ./get-encounters.js
    next:
      get-parent-and-child-teis:
        disabled: false
        condition: |
          !state.errors && state.encounters.length > 0
        name: has-encounters
  - id: get-parent-and-child-teis
    name: Get Parent and Child TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./get-parent-and-child-teis.js
    next:
      create-child-teis:
        disabled: false
        condition:
          "!state.errors && Object.keys(state.childTeisToCreate).length > 0"
        name: has-child-teis-to-create
      event-mappings:
        disabled: false
        condition:
          "!state.errors && Object.keys(state.childTeisToCreate).length === 0 &&
          state.existingTeis"
        name: has-existing-teis
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: a3d3dca3-6afa-4697-8a70-dbccfa41b013
    expression: ./get-patients.js
    next:
      mappings:
        disabled: false
        condition: on_job_success
  - id: mappings
    name: Mappings
    adaptor: "@openfn/language-common@2.1.1"
    configuration: 85712d34-82e4-4558-998d-b399891d488f
    expression: ./mappings.js
    next:
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        name: has-patients
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        name: has-no-patients
  - id: update-teis
    name: Update TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./update-teis.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: 7b295e5a-7a10-4917-8f03-f937fef0001e
    expression: ./upsert-teis.js
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        name: has-patient-uuids
