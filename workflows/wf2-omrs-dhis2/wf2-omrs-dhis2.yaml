id: wf2-omrs-dhis2
name: wf2-omrs-dhis2
options: {}
steps:
  - id: trigger
    type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: 57a8ef61-a75f-4af2-8152-371d871e21bb
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      mappings:
        disabled: false
        openfn:
          uuid: e2f4678d-270b-430c-82f6-b5553c641def
    expression: ./get-patients.js
  - id: mappings
    name: Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: cec97e34-8c98-473c-87f0-f68391d38f3b
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: e48fdb3b-7287-4572-8888-ea1b1206b23d
    expression: ./mappings.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: c051248f-741e-4eba-8880-bb6a4ddf8883
    expression: ./upsert-teis.js
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      get-teis-and-map-answers:
        disabled: false
        condition: |
          !state.errors && state.encounters.length > 0
        openfn:
          uuid: 33cdeb8c-524d-4a9a-8530-647907096741
    expression: ./get-encounters.js
  - id: get-teis-and-map-answers
    name: Get TEIs and Map Answers
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      create-teis-relationship:
        disabled: false
        condition: |
          state?.relationshipsMapping?.length > 0
        openfn:
          uuid: 4d2e6fe6-f7d1-48c5-863c-9d7c886ac0e2
    expression: ./get-teis-and-map-answers.js
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      update-teis:
        disabled: false
        condition: |
          state?.teisToUpdate?.length > 0
        openfn:
          uuid: 457fb90b-4b2d-4090-8a95-8539e781044c
    expression: ./create-events.js
  - id: update-teis
    name: Update TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    expression: ./update-teis.js
  - id: event-mappings
    name: Event Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors
        openfn:
          uuid: 75db1f32-bff0-4db5-8265-12682e7097f0
    expression: ./event-mappings.js
  - id: create-teis-relationship
    name: Create TEIs Relationship
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      event-mappings:
        disabled: false
        condition: |
          state.childTeis && !state.errors
        openfn:
          uuid: 14519ad2-8496-4f43-89dd-a9942ac3d077
    expression: ./create-teis-relationship.js
