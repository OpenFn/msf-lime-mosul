const dhis2Map = {
  attr: {
    ageInMonth: "ihH5ur7jquC",
    firstName: "fa7uwpCKIwa",
    lastName: "Jt9BhFZkvP2",
    patientNumber: "P4wdYGkldeG", //DHIS2 ID -> "Patient Number"
    omrsPatientNumber: "ZBoxuExmxcZ", //MSF ID -> "OpenMRS Patient Number"
    omrsPatientUuid: "AYbfTPYMNJH", //"OpenMRS Patient UID"
    ageInYears: "T1iX2NuPyqS",
    birthdate: "WDp4nVor9Z7",
    placeOflivingMap: "rBtrjV1Mqkz", //Place of living
    sex: "qptKDiv9uPl",
  },
  de: {
    f50: {
      asthma: "AXoG311ik9e",
      cardiovascularDisorder: "bpsI6R1AYIb",
      cardiovascularOther: "dFDzcBWC4mP",
      childAdolescence: "TG4Z9U0Dviz",
      chronicKidneyDisease: "GBBL7viQXvt",
      copd: "HGUVMcvDNl0",
      depression: "Ds7biYZkd2d",
      diabetesTypeI: "G2k65mDPn2e",
      diabetesTypeII: "OGlbbWRjbQI",
      epilepsy: "oAxAngdds50",
      gestationalDiabetes: "Td54s1N65No",
      heartfailure: "oqHxcCMjpTK",
      hypertension: "Bew76ch1i4i",
      hypothyroidism: "wyjVWkgUdJG",
      otherMH: "C7zJtdEdZws",
      otherNCD: "mlDXttAXrWI",
      psychosis: "TSSN2CT6OGr",
      selfHarm: "TuK457D8sTi",
      stressRelated: "PRKYg4AApSm",
      substanceDisorder: "CFFTmUlb5un",
      estDeliveryDate: "aFc9FG0PaRf",
      antenatalConsultation: "J62aIKRxrBQ",
      contracepition: "b6dGoMJm1jO",
      pregnancyMethod: "clnZXAAKStw",
      observedComplication1: "as6ICto55cO",
      observedComplication2: "y8TsEYlp5ai",
      observedComplication3: "U4N9k9q8iM8",
      observedComplication4: "M3rXGXDLVjx",
      medication1: "gipSPNNghXK",
      medication2: "sZastBLPgJY",
      medication3: "SHEM1CY8873",
      medication4: "HIfDsB1IsSk",
      medication5: "X5Owq7U5Y4E",
      medication6: "cRm0JmltkJX",
      medication7: "TzL2jbQo6nH",
      medication8: "E1dUkfQ2v47",
      medication9: "H8E7EJgibdt",
      medication10: "ScOa7FiWJTm",
      specialistType1: "TsG88CXqaii",
      specialistType2: "GeqxZYGIjPC",
      specialistType3: "QThCIIp4FRC",
      ifOtherSpecialistType1: "u68lzJcSaBa",
      ifOtherSpecialistType2: "PO19ZbOBOO1",
      ifOtherSpecialistType3: "OdrZUtuEaUU",
      typeOfExit: "GfYgPVlB8xJ",
      ifDefaulterSpecify: "rt15OzSfaKf",
    },
    f49: {
      asthma: "pGT54AYo27j",
      copd: "ajFiLhKjK53",
      cardiovascularDisease: "ymMmDdzmXJB",
      otherCardiovascularDisorder: "Pl71DwAselm",
      hypertension: "mjnK3aUJuTa",
      epilepsy: "WpyNugbQKYk",
      depression: "yHYhmy1H46g",
      psychosis: "zWqzSMJlxCz",
      stressRelated: "CqqksYsDFDE",
      substanceDisorder: "QkgnTdel3HA",
      childAdolescence: "uXKjVsrotpW",
      selfHarm: "EAhwOfxv3Zx",
      otherMH: "UGcyXNE5aDG",
      estDeliveryDate: "aFc9FG0PaRf",
      antenatalConsultation: "J62aIKRxrBQ",
      contracepition: "b6dGoMJm1jO",
      pregnancyMethod: "clnZXAAKStw",
      isReadmission: "SjNE9mM7Yu4",
      ncdEventDate: "IgRurcU3NO7",
      diabetesTypeI: "onGHyvZ2RmZ",
      diabetesTypeII: "E9BaT4zG4J4",
      gestationalDiabetes: "iFvba0J2evJ",
      hypothyroidism: "J21496i94EP",
      chronicKidneyDisease: "JznJsvXpTnK",
      observedComplication1: "Ff5TAZQB2Gx",
      observedComplication2: "jy6y43zcjIF",
      observedComplication3: "nroQVwfad5s",
      observedComplication4: "zzlWrNP7L9F",
      heartfailure: "eQfdTbag11h",
      medication1: "pfOVAvGLYVi",
      medication2: "iY9Y8G4uOod",
      medication3: "q3QvzsuauGq",
      medication4: "ekSky9wr0MO",
      medication5: "zgSRhgLfTn4",
      medication6: "nimcdwULYjp",
      medication7: "NfDhplV9xJA",
      medication8: "LBWHFdwKzKO",
      medication9: "VIXCChJKawm",
      medication10: "wrVSDgmMj4j",
      specialistType1: "Atg3aAfVv2V",
      specialistType2: "a35jmcOCCwc",
      specialistType3: "eurWUL2l6Gw",
      ifOtherSpecialistType1: "iXRsVYYypkU",
      ifOtherSpecialistType2: "xnpdL9cgpDH",
      ifOtherSpecialistType3: "NYEmxR8LW75",
    },

    otherNCD: "n36Fq9tLoWJ",

    extremistFootExam: "gPplT1Gk1uB",
    hba1cValue: "QJXo4pwCxJR",
    totalCholesterolValue: "YAkbJFXtTFU",
    creatinineDone: "nqINkxxSTe1",
    creatinineMg: "m2g3w4b3b4b",
    creatinineMgPerDl: "pG7e3WfYoTL",
    creatinineUmolPerl: "BdSAkE2x4k2",
    creatinineEgfr: "qd60Le4nrd6",
    creatinineMlPerMin: "dV5ngpIQymO",
    urineAnalysis: "tK9u009wENy",
    altDone: "AosqYtkFCzH",
    kDone: "Ucg0LjdAiqu",
    tshDone: "bG9RawjSauF",
    inrDone: "pdzQ3dYXcKh",
    ldlDone: "NqrNohB1MRq",
    ecg: "zmn2V11p3SW",
    echo: "DWYLDxxZpK5",
  },
};

const isValidUUID = (id) => {
  if (!id || typeof id !== "string") return false;

  const UUID_PATTERN =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  return UUID_PATTERN.test(id);
};

collections.get("mosul-metadata-mappings-staging").then((state) => {
  state.optsMap = state.data
    .filter((i) => i.key.includes("optsMap-value-"))
    .map((i) => i.value);

  state.identifiers = state.data
    .filter((i) => i.key.includes("identifiers-value-"))
    .map((i) => i.value);
  state.syncedAt = state.data.find((i) => i.key === "syncedAt")?.value;
  state.formMetadata = state.data.find((i) => i.key === "formMetadata")?.value;
  state.placeOflivingMap = state.data.find(
    (i) => i.key === "placeOflivingMap"
  )?.value;
  state.sourceFile = state.data.filter(
    (i) => i.key === "sourceFile"
  )?.[0]?.value;
  state.fileDateModified = state.data.filter(
    (i) => i.key === "fileDateModified"
  )?.[0]?.value;
  state.formMaps = state.data.find((i) => i.key === "formMaps")?.value;

  // TODO: Remove state.optionSetKey, when needed
  // Build from state.formMaps
  state.optionSetKey = state.data.filter(
    (i) => i.key === "optionSetKey"
  )?.[0]?.value;

  delete state.data;
  delete state.references;
  return state;
});

fn((state) => {
  const { formMetadata, identifiers, ...rest } = state;

  rest.v2FormUuids = formMetadata
    .filter(
      (form) =>
        isValidUUID(form["OMRS form.uuid"]) &&
        form["OMRS Form Version"] === "v4-2025"
    )
    .map((form) => form["OMRS form.uuid"]);
  rest.formUuids = formMetadata
    .filter(
      (form) =>
        isValidUUID(form["OMRS form.uuid"]) && form["Workflow"] === "WF2"
    )
    .map((form) => form["OMRS form.uuid"]);

  rest.patientProgramStage = "vN61drMkGqO";

  rest.orgUnit = "sUpt0j2GmBD";
  // rest.orgUnit = identifiers.find(i => i.type === 'ORG_UNIT')?.[
  //   'dhis2 attribute id'
  // ];
  rest.program = "dWdzxMuKa8Z";
  // rest.program = identifiers.find(i => i.type === 'PROGRAM')?.[
  //   'dhis2 attribute id'
  // ];
  // rest.patientProgramStage = state.formMaps.patient.programStage;

  rest.dhis2PatientNumber = identifiers.find(
    (i) => i.type === "DHIS2_PATIENT_NUMBER"
  )?.["omrs identifierType"]; //DHIS2 ID or DHIS2 Patient Number

  rest.openmrsAutoId = identifiers.find((i) => i.type === "OPENMRS_AUTO_ID")?.[
    "omrs identifierType"
  ]; //MSF ID or OpenMRS Patient Number

  rest.dhis2Map = dhis2Map;
  return rest;
});
