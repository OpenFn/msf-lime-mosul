id: wf2-omrs-dhis2-155
name: wf2-omrs-dhis2-155
options: {}
steps:
  - id: trigger
    type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: e6d63414-33bd-4d1b-8cab-00145818b9e0
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      mappings:
        disabled: false
        openfn:
          uuid: 39ea571e-ca02-4028-832f-431f07b71313
    expression: ./get-patients.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: d5311583-a26d-4ab3-8ab5-b91d69bb40b0
    expression: ./upsert-teis.js
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      get-teis-and-map-answers:
        disabled: false
        condition: |
          !state.errors && state.encounters
        openfn:
          uuid: f88c2468-3669-4be6-854d-bb5e242ea61c
    expression: ./get-encounters.js
  - id: get-teis-and-map-answers
    name: Get TEIs and Map Answers
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      event-mappings:
        disabled: false
        condition: |
          state.TEIs && !state.errors
        openfn:
          uuid: a7539e89-b11e-4463-875e-dbece104a6b9
    expression: ./get-teis-and-map-answers.js
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      update-teis:
        disabled: false
        condition: |
          state?.teisToUpdate?.length > 0
        openfn:
          uuid: b6f50cd9-b006-4c32-8c51-79092706d45f
    expression: ./create-events.js
  - id: mappings
    name: Mappings
    adaptor: "@openfn/language-http@6.5.1"
    next:
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: 2d014040-fc9a-4f09-8c83-6c02bedf64c9
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: bd6b949a-7e06-494c-8023-a484731179a1
    expression: ./mappings.js
  - id: update-teis
    name: Update TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    expression: ./update-teis.js
  - id: event-mappings
    name: Event Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors
        openfn:
          uuid: 8eb9b9c0-b851-4887-87af-0233dc4d1b33
    expression: ./event-mappings.js
