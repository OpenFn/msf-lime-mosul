id: v1-wf2-omrs-dhis2-f30
name: v1-wf2-omrs-dhis2-f30
options: {}
steps:
  - id: trigger
    # type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: ede1698f-b837-4044-82c5-7f67b08d3f10
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    state: ./tmp/state.json
    configuration: ../../tmp/openmrs-creds.json
    next:
      mappings:
        disabled: false
        condition: true
        openfn:
          uuid: 49ed4fd1-3926-4437-88dd-785deabb2d2b
    expression: ./get-patients.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: ../../tmp/dhis2-creds.json
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: 7f6e10b7-0a8a-45b2-8891-9f160cd5eb66
    expression: ./upsert-teis.js
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: ../../tmp/openmrs-creds.json
    next:
      get-teis-and-map-answers:
        disabled: false
        condition: |
          !state.errors && state.encounters
        openfn:
          uuid: e62c28fd-dbad-47ff-8657-598c599eccb1
    expression: ./get-encounters.js
  - id: get-teis-and-map-answers
    name: Get TEIs and Map Answers
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: ../../tmp/dhis2-creds.json
    next:
      event-mappings:
        disabled: false
        condition: |
          state.TEIs && !state.errors
        openfn:
          uuid: 8a89d015-163c-4684-87ed-3daddb0cfd24
    expression: ./get-teis-and-map-answers.js
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: ../../tmp/dhis2-creds.json
    next:
      update-teis:
        disabled: false
        condition: |
          state?.teisToUpdate?.length > 0
        openfn:
          uuid: 21a89ef9-5379-49dd-8314-b00c4260a0cd
    expression: ./create-events.js
  - id: mappings
    name: Mappings
    adaptor: "@openfn/language-http@6.5.1"
    next:
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: fd4592ab-b27c-4741-8dc4-ef735261e1ba
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: 550e9b78-1ccf-472a-8075-b6e702e02399
    expression: ./mappings.js
  - id: update-teis
    name: Update TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: ../../tmp/dhis2-creds.json
    expression: ./update-teis.js
  - id: event-mappings
    name: Event Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors
        openfn:
          uuid: 79e77694-22a8-4d77-83ab-04a7a7b368b1
    expression: ./event-mappings.js
