id: wf2-omrs-dhis2-137
name: wf2-omrs-dhis2-137
options: {}
steps:
  - id: trigger
    # type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: e5a1e40b-a435-495b-8260-3ddf4e4b6f95
  - id: get-patients
    name: Get Patients
    state: ./tmp/state.json
    configuration: ../tmp/openmrs-creds.json
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      mappings:
        disabled: false
        condition: |
          !state.errors
        openfn:
          uuid: 704bb712-f0be-4199-83b8-c84a3da5feb5
    expression: ./get-patients.js
  - id: mappings
    name: Mappings
    configuration: ../tmp/collections-creds.json
    adaptors: 
      - "@openfn/language-common@2.1.1"
      - "@openfn/language-collections@0.7.15"
    next:
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: 0fd2390e-6faf-4da6-8d4a-220685fe22ae
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: 5953cda9-d8c3-454a-8a05-aac6c9c07eb5
    expression: ./mappings.js
  - id: upsert-teis
    name: Upsert TEIs
    configuration: ../tmp/dhis2-creds.json
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: 26954f83-daed-4f98-8011-c2c5bc24ecd3
    expression: ./upsert-teis.js
  - id: get-encounters
    name: Get Encounters
    configuration: ../tmp/openmrs-creds.json
    adaptor: "@openfn/language-openmrs@4.3.0"
    next:
      get-parent-and-child-teis:
        disabled: false
        condition: |
          !state.errors && state.encounters.length > 0
        openfn:
          uuid: 44fda748-0643-46bb-8e89-4b75bec4bdbd
    expression: ./get-encounters.js
  - id: get-parent-and-child-teis
    name: Get Parent and Child TEIs
    configuration: ../tmp/dhis2-creds.json
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      upsert-child-teis:
        disabled: false
        condition: >
          Object.keys(state?.childTeis)?.length > 0 &&
          Object.keys(state?.parentTeis)?.length > 0
        openfn:
          uuid: a07cd9c9-a88e-4854-8186-23a9f98a8103
    expression: ./get-parent-and-child-teis.js
  - id: create-events
    name: Create Events
    configuration: ../tmp/dhis2-creds.json
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      update-teis:
        disabled: false
        condition: |
          state?.teisToUpdate?.length > 0
        openfn:
          uuid: 30bc10fc-d40f-4704-81f4-a05fefc5e1e3
    expression: ./create-events.js
  - id: update-teis
    name: Update TEIs
    configuration: ../tmp/dhis2-creds.json
    adaptor: "@openfn/language-dhis2@5.0.1"
    expression: ./update-teis.js
  - id: event-mappings
    name: Event Mappings
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors
        openfn:
          uuid: a314d87c-3497-4036-831a-3227d85b8c6b
    expression: ./event-mappings.js
  - id: create-teis-relationship
    name: Create TEIs Relationship
    configuration: ../tmp/dhis2-creds.json
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      event-mappings:
        disabled: false
        condition: |
          state.childTeis && !state.errors
        openfn:
          uuid: d11da1ea-7d5d-4021-8ecb-9394be06623d
    expression: ./create-teis-relationship.js
  - id: upsert-child-teis
    name: Upsert Child TEIs
    configuration: ../tmp/dhis2-creds.json
    adaptor: "@openfn/language-dhis2@5.0.1"
    next:
      create-teis-relationship:
        disabled: false
        condition: | 
          !state.errors
        openfn:
          uuid: b5de09be-bff1-45fb-8726-ad8e8e02c2ca
    expression: ./upsert-child-teis.js
