id: wip-165-wf3-omrs-dhis2
name: "[WIP-165]wf3-omrs-dhis2"
options: {}
steps:
  - id: trigger
    type: cron
    next:
      get-patients:
        disabled: false
        condition: true
        openfn:
          uuid: 95452617-f0d9-4e94-85f9-bd70b8013b6d
  - id: get-mappings-from-collection
    name: Get Mappings from Collection
    adaptors: ["@openfn/language-common@2.3.0", "@openfn/language-collections@0.7.16"]
    configuration: "../../tmp/collections-creds.json"
    next:
      get-encounters:
        disabled: false
        condition: |
          !state.errors && state.patients.length === 0
        openfn:
          uuid: ef91393e-9606-4b06-8062-1ad56b22a4b4
      upsert-teis:
        disabled: false
        condition: |
          state.patients.length > 0 && !state.errors
        openfn:
          uuid: 08b142f1-32f6-4820-8cd5-4c25c5b6e7f2
    expression: ./get-mappings-from-collection.js
  - id: get-encounters
    name: Get Encounters
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: "../../tmp/openmrs-creds.json"
    next:
      get-teis-and-map-answers:
        disabled: false
        condition: |
          !state.errors && state?.encountersByVisit
        openfn:
          uuid: ab510a69-b607-43d5-880d-f771244eb30c
    expression: ./get-encounters.js
  - id: create-events
    name: Create Events
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: "../../tmp/dhis2-creds.json"
    expression: ./create-events.js
  - id: custom-logic-for-events
    name: Custom Logic for Events
    adaptor: "@openfn/language-common@2.1.1"
    next:
      create-events:
        disabled: false
        condition: |
          state?.eventsMapping?.length > 0 && !state.errors && !state.testMode
        openfn:
          uuid: 1b747666-3794-4e86-8fa9-d893bc5882e6
    expression: ./custom-logic-for-events.js
  - id: get-patients
    name: Get Patients
    adaptor: "@openfn/language-openmrs@4.3.0"
    configuration: "../../tmp/openmrs-creds.json"
    state: "../../tmp/wf3-omrs-dhis2-state.json"
    next:
      get-mappings-from-collection:
        disabled: false
        condition: | 
          !state.errors
        openfn:
          uuid: 32f81f0e-ac02-4c29-8e7f-259bc412175f
    expression: ./get-patients.js
  - id: upsert-teis
    name: Upsert TEIs
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: "../../tmp/dhis2-creds.json"
    next:
      get-encounters:
        disabled: false
        condition: |
          state.patientUuids.length > 0 && !state.errors
        openfn:
          uuid: adde9f10-1a60-46fc-8f78-ef65e40e844b
    expression: ./upsert-teis.js
  - id: get-teis-and-map-answers
    name: Get TEIs and Map Answers
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: "../../tmp/dhis2-creds.json"
    next:
      custom-logic-for-events:
        disabled: false
        condition: |
          state.TEIs && !state.errors
        openfn:
          uuid: 981d6768-8c0c-4a4e-8a49-69e2e1c32174
    expression: ./get-teis-and-map-answers.js
  - id: get-tie
    name: Get Tie
    adaptor: "@openfn/language-dhis2@5.0.1"
    configuration: "../../tmp/dhis2-creds.json"
    next:
      custom-logic-for-events:
        disabled: false
        condition: |
          state.testMode
        openfn:
          uuid: cb3eed77-e79f-4626-8588-5bfeb2379025
    expression: ./get-tie.js
