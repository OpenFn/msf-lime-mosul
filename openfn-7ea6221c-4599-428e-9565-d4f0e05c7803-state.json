{
  "env": "main",
  "id": "7ea6221c-4599-428e-9565-d4f0e05c7803",
  "name": "msf-lime-mosul-staging",
  "description": "staging project for main MSF workflows\n",
  "color": null,
  "concurrency": null,
  "inserted_at": "2025-01-30T11:16:04Z",
  "updated_at": "2025-12-08T17:57:21Z",
  "parent_id": null,
  "scheduled_deletion": null,
  "history_retention_period": 365,
  "dataclip_retention_period": 365,
  "retention_policy": "retain_all",
  "project_credentials": {
    "mtuchi@openfn.org-mtuchi-github-token": {
      "id": "0fa0d3d1-0caa-4f8f-8952-f0b2e2ce51ea",
      "name": "mtuchi-github-token",
      "owner": "mtuchi@openfn.org"
    },
    "mtuchi@openfn.org-OpenMRS-Demo": {
      "id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08",
      "name": "OpenMRS Demo",
      "owner": "mtuchi@openfn.org"
    },
    "mtuchi@openfn.org-OpenFnSharepoint": {
      "id": "49fdae45-c33e-498a-9441-e0c0b4a61568",
      "name": "OpenFnSharepoint",
      "owner": "mtuchi@openfn.org"
    },
    "mtuchi@openfn.org-MSF-DHIS2-UAT": {
      "id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f",
      "name": "MSF DHIS2 UAT",
      "owner": "mtuchi@openfn.org"
    },
    "mtuchi@openfn.org-mtuchi-collections-config": {
      "id": "90cddfa1-9b77-4625-a812-2a04d061522c",
      "name": "mtuchi-collections-config",
      "owner": "mtuchi@openfn.org"
    },
    "aisha@openfn.org-MSF-OMRS-admin": {
      "id": "d2c62b09-c071-4cbe-95e5-b703aba863f3",
      "name": "MSF OMRS admin",
      "owner": "aisha@openfn.org"
    }
  },
  "version_history": [],
  "collections": {},
  "workflows": {
    "wf2-omrs-dhis2": {
      "id": "648e9d15-3ccf-4751-aa83-94627d6de843",
      "name": "wf2-omrs-dhis2",
      "inserted_at": "2025-12-11T13:54:43.293637Z",
      "lock_version": 37,
      "triggers": {
        "cron": {
          "enabled": false,
          "id": "d10691b1-666f-4e0f-8064-40d4ce8fdc32",
          "type": "cron",
          "cron_expression": "0 0 * * *"
        }
      },
      "jobs": {
        "Get-Patients": {
          "id": "9cc0cbea-ba1a-4555-83a1-a191944f303e",
          "name": "Get Patients",
          "body": "function removeLinks(data) {\n  if (Array.isArray(data)) {\n    return data.map(removeLinks);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const { links, ...rest } = data;\n    return Object.fromEntries(\n      Object.entries(rest).map(([key, value]) => [key, removeLinks(value)])\n    );\n  }\n\n  return data;\n}\n\nfunction removeNulls(data) {\n  if (Array.isArray(data)) {\n    return data.filter((item) => item !== null).map(removeNulls);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const result = {};\n    for (const [key, value] of Object.entries(data)) {\n      if (value !== null) {\n        result[key] = removeNulls(value);\n      }\n    }\n    return result;\n  }\n\n  return data;\n}\n\ncursor($.lastRunDateTime || \"2025-03-20T06:01:24.000Z\");\n\ncursor(\"today\", {\n  key: \"lastRunDateTime\",\n  format: (c) => dateFns.format(new Date(c), \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\"),\n});\n\nsearchPatient({ q: $.msfId || \"IQ\", v: \"full\", limit: \"100\" });\n\nfn((state) => {\n  const { cursor, data } = state;\n  console.log(\"Filtering patients since cursor:\", cursor);\n  console.log(\"Patient fetched\", data.results.length);\n\n  state.patients = data.results\n    .filter(({ auditInfo }) => {\n      const lastModified = auditInfo?.dateChanged || auditInfo?.dateCreated;\n      return lastModified > cursor;\n    })\n    .map((p) => {\n      const { uuid, auditInfo, identifiers, person } = removeLinks(\n        removeNulls(p)\n      );\n      const { dateCreated } = auditInfo;\n      const { age, birthdate, gender, names, addresses, attributes } = person;\n\n      return {\n        uuid,\n        person: {\n          age,\n          birthdate,\n          gender,\n          names,\n          addresses: [addresses.find((a) => a.cityVillage)],\n          attributes,\n        },\n        identifiers,\n        auditInfo: { dateCreated },\n      };\n    });\n  state.searchPatientUuids = state.patients.map((p) => p.uuid);\n  console.log(\"# of patients to sync to dhis2 ::\", state.patients.length);\n\n  return state;\n});\n\n// Fetch all encounters\nhttp\n  .get(\"/ws/fhir2/R4/Encounter\", {\n    query: { _count: 100, _lastUpdated: `ge${$.cursor}` },\n  })\n  .then((state) => {\n    const { link, total } = state.data;\n    state.nextUrl = link\n      .find((l) => l.relation === \"next\")\n      ?.url.replace(/(_count=)\\d+/, `$1${total}`)\n      .split(\"/openmrs\")[1];\n\n    state.allResponse = state.data;\n    return state;\n  });\n\nfnIf(\n  $.nextUrl,\n  http.get($.nextUrl).then((state) => {\n    console.log(`Fetched ${state.data.entry.length} remaining encounters`);\n    delete state.allResponse.link;\n    state.allResponse.entry.push(...state.data.entry);\n    return state;\n  })\n);\n\nfn((state) => {\n  console.log(\n    \"Total # of encounters fetched: \",\n    state.allResponse?.entry?.length\n  );\n\n  const uuids = [\n    ...new Set(\n      state.allResponse?.entry?.map((p) =>\n        p.resource?.subject?.reference?.replace(\"Patient/\", \"\")\n      )\n    ),\n  ];\n  state.encounterPatientUuids = [...new Set(uuids)];\n\n  return state;\n});\n\nfn((state) => {\n  const {\n    cursor,\n    lastRunDateTime,\n    patients,\n    searchPatientUuids,\n    encounterPatientUuids,\n  } = state;\n\n  const onlyInSearchPatient = searchPatientUuids.filter(\n    (id) => !encounterPatientUuids.includes(id)\n  );\n\n  const onlyInR4Encounter = encounterPatientUuids.filter(\n    (id) => !searchPatientUuids.includes(id)\n  );\n  const inbothResults = searchPatientUuids.filter((id) =>\n    encounterPatientUuids.includes(id)\n  );\n  const patientUuids = [\n    ...new Set([...searchPatientUuids, ...encounterPatientUuids]),\n  ];\n\n  console.log(\"inbothResults\", inbothResults.length);\n  console.log(\"patient-search-array\", onlyInSearchPatient.length);\n  console.log(\"r4-encounter-array\", onlyInR4Encounter.length);\n  console.log(\"combined uuids\", patientUuids.length);\n\n  return { cursor, lastRunDateTime, patients, patientUuids };\n});\n",
          "adaptor": "@openfn/language-openmrs@4.3.0",
          "project_credential_id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08"
        },
        "Mappings": {
          "id": "0a6f5426-9c6d-4214-8e05-55cb9e368e14",
          "name": "Mappings",
          "body": "const isValidUUID = (id) => {\n  if (!id || typeof id !== \"string\") return false;\n\n  const UUID_PATTERN =\n    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n  return UUID_PATTERN.test(id);\n};\n\ncollections.get(\"mosul-metadata-mappings-main\").then((state) => {\n  state.optsMap = state.data\n    .filter((i) => i.key.includes(\"optsMap-value-\"))\n    .map((i) => i.value);\n\n  state.identifiers = state.data\n    .filter((i) => i.key.includes(\"identifiers-value-\"))\n    .map((i) => i.value);\n  state.syncedAt = state.data.find((i) => i.key === \"syncedAt\")?.value;\n  state.formMetadata = state.data.find((i) => i.key === \"formMetadata\")?.value;\n  state.placeOflivingMap = state.data.find(\n    (i) => i.key === \"placeOflivingMap\"\n  )?.value;\n  state.sourceFile = state.data.filter(\n    (i) => i.key === \"sourceFile\"\n  )?.[0]?.value;\n  state.fileDateModified = state.data.filter(\n    (i) => i.key === \"fileDateModified\"\n  )?.[0]?.value;\n  state.formMaps = state.data.find((i) => i.key === \"formMaps\")?.value;\n\n  // TODO: Remove state.optionSetKey, when needed\n  // Build from state.formMaps\n  state.optionSetKey = state.data.filter(\n    (i) => i.key === \"optionSetKey\"\n  )?.[0]?.value;\n\n  delete state.data;\n  delete state.references;\n  return state;\n});\n\nfn((state) => {\n  const { formMetadata, identifiers, ...rest } = state;\n\n  rest.v2FormUuids = formMetadata\n    .filter(\n      (form) =>\n        isValidUUID(form[\"OMRS form.uuid\"]) &&\n        form[\"OMRS Form Version\"] === \"v4-2025\"\n    )\n    .map((form) => form[\"OMRS form.uuid\"]);\n  rest.formUuids = formMetadata\n    .filter(\n      (form) =>\n        isValidUUID(form[\"OMRS form.uuid\"]) && form[\"Workflow\"] === \"WF2\"\n    )\n    .map((form) => form[\"OMRS form.uuid\"]);\n\n  rest.patientProgramStage = \"vN61drMkGqO\";\n\n  rest.orgUnit = \"sUpt0j2GmBD\";\n  // rest.orgUnit = identifiers.find(i => i.type === 'ORG_UNIT')?.[\n  //   'dhis2 attribute id'\n  // ];\n  rest.program = \"dWdzxMuKa8Z\";\n  // rest.program = identifiers.find(i => i.type === 'PROGRAM')?.[\n  //   'dhis2 attribute id'\n  // ];\n  // rest.patientProgramStage = state.formMaps.patient.programStage;\n\n  rest.dhis2PatientNumber = identifiers.find(\n    (i) => i.type === \"DHIS2_PATIENT_NUMBER\"\n  )?.[\"omrs identifierType\"]; //DHIS2 ID or DHIS2 Patient Number\n\n  rest.openmrsAutoId = identifiers.find((i) => i.type === \"OPENMRS_AUTO_ID\")?.[\n    \"omrs identifierType\"\n  ]; //MSF ID or OpenMRS Patient Number\n\n  return rest;\n});\n",
          "adaptor": "@openfn/language-common@2.1.1",
          "project_credential_id": "90cddfa1-9b77-4625-a812-2a04d061522c"
        },
        "Upsert-TEIs": {
          "id": "5f47a65c-b739-46d7-8fa3-8a722458d4a3",
          "name": "Upsert TEIs",
          "body": "function chunkArray(array, size) {\n  const chunks = [];\n  for (let i = 0; i < array.length; i += size) {\n    chunks.push(array.slice(i, i + size));\n  }\n  return chunks;\n}\n\nconst buildTeiMapping = (omrsPatient, patientTei, mappingConfig) => {\n  const genderMap = {\n    M: \"male\",\n    O: \"unknown\",\n    F: \"female\",\n    U: \"unknown\",\n  };\n  const {\n    orgUnit,\n    program,\n    optsMap,\n    formMaps,\n    placeOflivingMap,\n    patientProgramStage,\n    dhis2PatientNumber,\n    openmrsAutoId,\n  } = mappingConfig;\n\n  const enrolledAt = omrsPatient.auditInfo.dateCreated.substring(0, 10);\n  const findIdentifierByUuid = (identifiers, targetUuid) =>\n    identifiers.find((i) => i.identifierType.uuid === targetUuid)?.identifier;\n\n  const findAttrValue = (uuid) => {\n    return omrsPatient.person.attributes.find(\n      (a) => a.attributeType.uuid === uuid\n    )?.value;\n  };\n\n  const findOptCodeByUuid = (uuid) => {\n    return optsMap.find((o) => o[\"value.uuid - External ID\"] === uuid)?.[\n      \"DHIS2 Option Code\"\n    ];\n  };\n\n  const findOptCode = (attrValue) => {\n    if (typeof attrValue === \"string\") {\n      return findOptCodeByUuid(attrValue);\n    }\n    if (typeof attrValue === \"object\") {\n      const { uuid, display } = attrValue;\n      const optCodeByDisplay = optsMap.find(\n        (o) =>\n          o[\"value.uuid - External ID\"] === uuid &&\n          o[\"value.display - Answers\"] === display\n      )?.[\"DHIS2 Option Code\"];\n\n      return optCodeByDisplay ?? findOptCodeByUuid(uuid);\n    }\n    return null;\n  };\n\n  const patientMap = formMaps.patient.dataValueMap;\n  const statusAttrMaps = Object.keys(patientMap).map((d) => {\n    const attrValue = findAttrValue(patientMap[d]);\n\n    return {\n      attribute: d,\n      value: findOptCode(attrValue) || attrValue,\n    };\n  });\n\n  const standardAttr = [\n    {\n      attribute: \"fa7uwpCKIwa\",\n      value: omrsPatient.person?.names[0]?.givenName,\n    },\n    {\n      attribute: \"Jt9BhFZkvP2\",\n      value: omrsPatient.person?.names[0]?.familyName,\n    },\n    {\n      attribute: \"P4wdYGkldeG\", //DHIS2 ID ==> \"Patient Number\"\n      value:\n        findIdentifierByUuid(omrsPatient.identifiers, dhis2PatientNumber) ||\n        findIdentifierByUuid(omrsPatient.identifiers, openmrsAutoId), //map OMRS ID if no DHIS2 id\n    },\n    {\n      attribute: \"ZBoxuExmxcZ\", //MSF ID ==> \"OpenMRS Patient Number\"\n      value: findIdentifierByUuid(omrsPatient.identifiers, openmrsAutoId),\n    },\n    {\n      attribute: \"AYbfTPYMNJH\", //\"OpenMRS Patient UID\"\n      value: omrsPatient.uuid,\n    },\n\n    {\n      attribute: \"T1iX2NuPyqS\",\n      value: omrsPatient.person.age,\n    },\n    {\n      attribute: \"WDp4nVor9Z7\",\n      value: omrsPatient.person.birthdate?.slice(0, 10),\n    },\n    {\n      attribute: \"rBtrjV1Mqkz\", //Place of living\n      value: placeOflivingMap[omrsPatient.person?.addresses[0]?.cityVillage],\n    },\n  ];\n\n  //filter out attributes that don't have a value from dhis2\n  const filteredAttr = standardAttr.filter((a) => a.value);\n  const filteredStatusAttr = statusAttrMaps.filter((a) => a.value);\n\n  const payload = {\n    program,\n    orgUnit,\n    attributes: [...filteredAttr, ...filteredStatusAttr],\n  };\n  // console.log('mapped dhis2 payloads:: ', JSON.stringify(payload, null, 2));\n  const enrollments = [\n    {\n      orgUnit,\n      program,\n      enrolledAt,\n      programStage: patientProgramStage, //'MdTtRixaC1B',\n    },\n  ];\n\n  if (!patientTei) {\n    payload.trackedEntityType = \"cHlzCA2MuEF\";\n\n    payload.attributes.push({\n      attribute: \"qptKDiv9uPl\",\n      value: genderMap[omrsPatient.person.gender],\n    });\n    console.log(\"create enrollment\");\n    payload.enrollments = enrollments;\n  }\n\n  if (patientTei) {\n    payload.trackedEntity = patientTei.trackedEntity;\n    payload.trackedEntityType = patientTei.trackedEntityType;\n  }\n\n  return payload;\n};\n\nconst delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n\neach(\n  (state) => chunkArray(state.patients, 200),\n  get(\"tracker/trackedEntities\", {\n    orgUnit: $.orgUnit,\n    filter: (state) => [\n      `AYbfTPYMNJH:IN:${state.data.map((patient) => patient.uuid).join(\";\")}`,\n    ],\n    program: $.program,\n    fields: \"*\",\n  }).then((state) => {\n    state.foundTrackedEntities ??= [];\n    state.foundTrackedEntities.push(...state.data.instances);\n    return state;\n  })\n);\n\nfn((state) => {\n  const findTeiByUuid = (patientUuid) => {\n    return state.foundTrackedEntities.find((tei) => {\n      return (\n        tei.attributes.find(\n          (attribute) => attribute.attribute === \"AYbfTPYMNJH\"\n        )?.value === patientUuid\n      );\n    });\n  };\n\n  state.patientsMapping = state.patients.map((patient) => {\n    const patientTei = findTeiByUuid(patient.uuid);\n\n    return buildTeiMapping(patient, patientTei, {\n      placeOflivingMap: state.placeOflivingMap,\n      orgUnit: state.orgUnit,\n      program: state.program,\n      patientProgramStage: state.patientProgramStage,\n      formMaps: state.formMaps,\n      optsMap: state.optsMap,\n      dhis2PatientNumber: state.dhis2PatientNumber,\n      openmrsAutoId: state.openmrsAutoId,\n    });\n  });\n\n  return state;\n});\n\n// Bulk upsert\ncreate(\n  \"tracker\",\n  { trackedEntities: $.patientsMapping },\n  {\n    params: {\n      atomicMode: \"ALL\",\n      importStrategy: \"CREATE_AND_UPDATE\",\n      async: false,\n    },\n  }\n);\nfn((state) => {\n  const {\n    data,\n    response,\n    references,\n    patients,\n    patientsUpsert,\n    placeOflivingMap,\n    identifiers,\n    ...next\n  } = state;\n  next.patientUuids = patients.map((p) => p.uuid);\n  return next;\n});\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Get-Encounters": {
          "id": "ea92d31b-95a2-4683-85d5-f591513dbccc",
          "name": "Get Encounters",
          "body": "function removeLinks(data) {\n  if (Array.isArray(data)) {\n    return data.map(removeLinks);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const { links, ...rest } = data;\n    return Object.fromEntries(\n      Object.entries(rest).map(([key, value]) => [key, removeLinks(value)])\n    );\n  }\n\n  return data;\n}\n\nfunction removeNulls(data) {\n  if (Array.isArray(data)) {\n    return data.filter((item) => item !== null).map(removeNulls);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const result = {};\n    for (const [key, value] of Object.entries(data)) {\n      if (value !== null) {\n        result[key] = removeNulls(value);\n      }\n    }\n    return result;\n  }\n\n  return data;\n}\n// Fetch patient encounters\neach(\n  $.patientUuids,\n  get(\"encounter\", { patient: $.data, v: \"full\" }).then((state) => {\n    state.allEncounters ??= [];\n    state.allEncounters.push(\n      // v2FormsUuids are for mental health forms\n      // ...state.data.results.filter(e =>\n      //   state.v2FormUuids.includes(e?.form?.uuid)\n      // )\n      ...state.data.results.filter((e) =>\n        state.formUuids.includes(e?.form?.uuid)\n      )\n    );\n\n    const patientUuid = state.references.at(-1);\n    const filteredEncounters = state.formUuids.map((formUuid) =>\n      state.data.results\n        .filter(\n          (e) =>\n            e.auditInfo.dateCreated >= state.cursor &&\n            e?.form?.uuid === formUuid\n        )\n        .sort(\n          (a, b) =>\n            new Date(b.auditInfo.dateCreated) -\n            new Date(a.auditInfo.dateCreated)\n        )\n    );\n\n    const encounters = filteredEncounters\n      .map((pe) => {\n        const isLatestForm = pe.find((e) => {\n          return state.formMaps[e?.form?.uuid]?.syncType === \"latest\";\n        });\n        if (isLatestForm) {\n          return [isLatestForm];\n        } else {\n          const allPatientEncounter = pe.filter(\n            (e) => state.formMaps[e?.form?.uuid]?.syncType === \"all\"\n          );\n          return allPatientEncounter;\n        }\n      })\n      .flat();\n\n    state.encounters ??= [];\n    state.encounters.push(...encounters);\n\n    console.log(\n      encounters.length,\n      `# of filtered encounters found in OMRS for ${patientUuid}`\n    );\n\n    return state;\n  })\n);\n\nfn((state) => {\n  const {\n    data,\n    index,\n    response,\n    references,\n    allResponse,\n    patientUuids,\n    patients,\n    ...next\n  } = state;\n\n  if (next.encounters?.length) {\n    next.encounters = next.encounters.map((encounter) => {\n      const { uuid, patient, obs, form, encounterDatetime } = removeLinks(\n        removeNulls(encounter)\n      );\n\n      return {\n        uuid,\n        patient: {\n          uuid: patient.uuid,\n          display: patient.display,\n        },\n        obs: obs.map((o) => {\n          return {\n            uuid: o.uuid,\n            concept: o.concept,\n            display: o.display,\n            formFieldPath: o.formFieldPath,\n            value: o.value,\n            person: o.person,\n          };\n        }),\n        form: {\n          uuid: form.uuid,\n          display: form.display,\n          description: form.description,\n          name: form.name,\n        },\n        encounterDatetime,\n      };\n    });\n    console.log(next.encounters.length, \"# of new encounters to sync to dhis2\");\n  } else {\n    console.log(\"No encounters found for cursor: \", next.cursor);\n  }\n  next.allEncounters = next.allEncounters?.map((encounter) => {\n    const { uuid, patient, obs, form, encounterDatetime } = removeLinks(\n      removeNulls(encounter)\n    );\n\n    return {\n      uuid,\n      patient: {\n        uuid: patient.uuid,\n        display: patient.display,\n      },\n      obs: obs.map((o) => {\n        return {\n          uuid: o.uuid,\n          concept: o.concept,\n          display: o.display,\n          formFieldPath: o.formFieldPath,\n          value: o.value,\n          person: o.person,\n        };\n      }),\n      form: {\n        uuid: form.uuid,\n        display: form.display,\n        description: form.description,\n        name: form.name,\n      },\n      encounterDatetime,\n    };\n  });\n\n  return next;\n});\n",
          "adaptor": "@openfn/language-openmrs@4.3.0",
          "project_credential_id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08"
        },
        "Get-Parent-and-Child-TEIs": {
          "id": "29e87d9d-53c4-47bf-885d-19a70b839120",
          "name": "Get Parent and Child TEIs",
          "body": "const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n\nconst teiByPatientUuid = (patientUuid, teis) => {\n  return teis.find((tei) => {\n    const omrsPatientUuid = tei.attributes.find(\n      ({ attribute }) => attribute === \"AYbfTPYMNJH\"\n    )?.value;\n\n    return omrsPatientUuid === patientUuid;\n  });\n};\n\nfn((state) => {\n  // Group encounters by patient UUID\n  state.encountersByPatient = state.encounters.reduce((acc, obj) => {\n    const key = obj.patient.uuid;\n    if (!acc[key]) {\n      acc[key] = [];\n    }\n    acc[key].push(obj);\n    return acc;\n  }, {});\n\n  return state;\n});\n\nget(\"tracker/trackedEntities\", {\n  orgUnit: $.orgUnit,\n  program: $.program,\n  filter: (state) => [\n    `AYbfTPYMNJH:IN:${Object.keys(state.encountersByPatient).join(\";\")}`,\n  ],\n});\n\nfn((state) => {\n  state.parentTeis ??= {};\n  state.missingParentTeis ??= {};\n\n  Object.keys(state.encountersByPatient).forEach((patientUuid) => {\n    const parentTei = teiByPatientUuid(patientUuid, state.data.instances);\n    if (parentTei?.trackedEntity) {\n      console.log(\"Parent TEI found:\", parentTei.trackedEntity);\n\n      state.parentTeis[patientUuid] = {\n        trackedEntity: parentTei.trackedEntity,\n        attributes: parentTei.attributes,\n        trackedEntityType: parentTei.trackedEntityType,\n        enrollments: parentTei.enrollments,\n      };\n    } else {\n      console.log(\"Parent TEI Not Found for Patient:\", patientUuid);\n      state.missingParentTeis[patientUuid] =\n        state.encountersByPatient[patientUuid];\n    }\n  });\n\n  return state;\n});\n\nfn((state) => {\n  state.ouProgramEncounters = state.encounters.reduce((acc, obj) => {\n    const formUuid = obj.form.uuid;\n    const patientUuid = obj.patient.uuid;\n    const orgUnit = state.formMaps[formUuid].orgUnit;\n    const program = state.formMaps[formUuid].programId;\n    const key = `${orgUnit}-${program}`;\n    if (!acc[key]) {\n      acc[key] = {\n        orgUnit,\n        program,\n        patientUuids: [patientUuid],\n      };\n    }\n    if (!acc[key].patientUuids.includes(patientUuid)) {\n      acc[key].patientUuids.push(patientUuid);\n    }\n    return acc;\n  }, {});\n\n  return state;\n});\n\neach(\n  (state) => Object.values(state.ouProgramEncounters),\n  get(\"tracker/trackedEntities\", (state) => {\n    const { orgUnit, program, patientUuids } = state.data;\n    return {\n      orgUnit,\n      program,\n      filter: [`AYbfTPYMNJH:IN:${patientUuids.join(\";\")}`],\n      fields: \"*\",\n    };\n  })\n    .then((state) => {\n      state.childTeis ??= {};\n      state.encounters.forEach((encounter) => {\n        const patientUuid = encounter.patient.uuid;\n        const program = state.formMaps[encounter.form.uuid].programId;\n        const orgUnit = state.formMaps[encounter.form.uuid].orgUnit;\n\n        const tei = state.data.instances.find((tei) => {\n          const omrsPatientUuid = tei.attributes.find(\n            (attribute) => attribute.attribute === \"AYbfTPYMNJH\"\n          )?.value;\n          const teiProgram = tei.programOwners.find(\n            (po) => po.trackedEntity === tei.trackedEntity\n          )?.program;\n\n          return (\n            omrsPatientUuid === patientUuid &&\n            teiProgram === program &&\n            tei.orgUnit === orgUnit\n          );\n        });\n\n        const patientOuProgram = `${orgUnit}-${program}-${patientUuid}`;\n        const relationshipType =\n          state.formMaps[encounter.form.uuid]?.relationshipId;\n\n        if (tei?.trackedEntity) {\n          console.log(\"Child TEI found:\", tei.trackedEntity);\n          state.childTeis[patientOuProgram] = {\n            relationshipType,\n            trackedEntity: tei.trackedEntity,\n            attributes: tei.attributes,\n            trackedEntityType: tei.trackedEntityType,\n            enrollments: tei.enrollments,\n            orgUnit,\n            program,\n          };\n        }\n\n        if (!tei && !state.childTeis[patientOuProgram]) {\n          console.log(\"Child TEI not found for patient:\", patientUuid);\n          const { attributes, trackedEntityType } =\n            state?.parentTeis[patientUuid];\n\n          state.childTeis[patientOuProgram] = {\n            relationshipType,\n            trackedEntityType,\n            enrollments: [\n              {\n                orgUnit,\n                program,\n                enrolledAt: new Date().toISOString().split(\"T\")[0],\n                attributes: attributes.filter((attribute) =>\n                  [\n                    \"P4wdYGkldeG\", //DHIS2 ID ==> \"Patient Number\"\n                  ].includes(attribute.attribute)\n                ),\n              },\n            ],\n            attributes,\n            orgUnit,\n            program,\n          };\n        }\n      });\n\n      return state;\n    })\n    .then(async (state) => {\n      await delay(2000);\n      return state;\n    })\n);\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Create-Events": {
          "id": "bc9ae464-bc1c-42ef-8d8d-24614ce5e4f1",
          "name": "Create Events",
          "body": "const buildTeiUrl = (baseUrl, { trackedEntity, program, orgUnit }) => {\n  return `${baseUrl}/dhis-web-tracker-capture/index.html#/dashboard?tei=${trackedEntity}&program=${program}&ou=${orgUnit}`;\n};\n// Create or update events for each encounter\ncreate(\n  \"tracker\",\n  {\n    events: (state) => {\n      const baseUrl = state.configuration.hostUrl;\n\n      const groupedEvents = state.eventsMapping.reduce((acc, event) => {\n        const { trackedEntity, program, orgUnit } = event;\n        const key = `${trackedEntity}-${program}-${orgUnit}`;\n        if (!acc[key]) {\n          acc[key] = [];\n        }\n        acc[key].push(event);\n        return acc;\n      }, {});\n      Object.entries(groupedEvents).forEach(([key, events]) => {\n        const [trackedEntity, program, orgUnit] = key.split(\"-\");\n\n        const teiUrl = buildTeiUrl(baseUrl, {\n          trackedEntity,\n          program,\n          orgUnit,\n        });\n\n        console.log({ events, teiUrl });\n      });\n      return state.eventsMapping;\n    },\n  },\n  {\n    params: {\n      async: false,\n      dataElementIdScheme: \"UID\",\n      importStrategy: \"CREATE_AND_UPDATE\",\n    },\n  }\n);\n\nconst findlatestAnswer = (encounters, conceptUuid) => {\n  const latestAnswer = encounters.reduce((acc, e) => {\n    const answer = e.obs.find((o) => o.concept.uuid === conceptUuid);\n    if (answer) {\n      const personUuid = answer.person.uuid;\n      if (\n        !acc[personUuid] ||\n        new Date(answer.obsDatetime) > new Date(acc[personUuid].obsDatetime)\n      ) {\n        acc[personUuid] = { ...answer, formUuid: e.form.uuid };\n      }\n    }\n    return acc;\n  }, {});\n\n  return Object.values(latestAnswer);\n};\n\nfn((state) => {\n  const {\n    encounters,\n    childTeis,\n    parentTeis,\n    program,\n    orgUnit,\n    optsMap,\n    // Lighten state by removing unused properties\n    formMaps,\n    optionSetKey,\n    eventsMapping,\n    formUuids,\n    references,\n    ...next\n  } = state;\n\n  const genderMap = optsMap\n    .filter((o) => o[\"DHIS2 DE UID\"] === \"qptKDiv9uPl\")\n    .reduce((acc, obj) => {\n      acc[obj[\"value.display - Answers\"]] = obj[\"DHIS2 Option Code\"];\n      return acc;\n    }, {});\n\n  const latestGenderUpdate = findlatestAnswer(\n    encounters,\n    \"ec42d68d-3e23-43de-b8c5-a03bb538e7c7\"\n  );\n\n  const genderUpdated = latestGenderUpdate\n    .map((answer) => {\n      const chilProgram = formMaps[answer.formUuid].programId;\n      const childOrgUnit = formMaps[answer.formUuid].orgUnit;\n      const personUuid = answer.person.uuid;\n      const parentTei = parentTeis[personUuid].trackedEntity;\n      const childTei =\n        childTeis[`${childOrgUnit}-${chilProgram}-${personUuid}`].trackedEntity;\n\n      const mappings = [];\n      const sharedMapping = {\n        trackedEntityType: \"cHlzCA2MuEF\",\n        attributes: [\n          {\n            attribute: \"qptKDiv9uPl\", //gender\n            value: genderMap[answer.value.display],\n          },\n          {\n            attribute: \"AYbfTPYMNJH\", //OpenMRS Patient UID to use to upsert TEI\n            value: answer.person.uuid,\n          },\n        ],\n      };\n      if (!childTei) {\n        console.log(\"No TEI found for person\", answer.person.uuid);\n      }\n      if (childTei) {\n        mappings.push({\n          ...sharedMapping,\n          trackedEntityInstance: childTei,\n          program: chilProgram,\n          orgUnit: childOrgUnit,\n        });\n      }\n      if (parentTei) {\n        mappings.push({\n          ...sharedMapping,\n          trackedEntityInstance: parentTei,\n          program,\n          orgUnit,\n        });\n      }\n      return mappings;\n    })\n    .filter(Boolean)\n    .flat();\n\n  const latestEducationUpdate = findlatestAnswer(\n    encounters,\n    \"cc3a5a7a-abfe-4630-b0c0-c1275c6cbb54\"\n  );\n\n  // console.log({ latestEducationUpdate })\n  const educationUpdated = latestEducationUpdate\n    .map((answer) => {\n      const chilProgram = formMaps[answer.formUuid].programId;\n      const childOrgUnit = formMaps[answer.formUuid].orgUnit;\n      const personUuid = answer.person.uuid;\n      const parentTei = parentTeis[personUuid]?.trackedEntity;\n      const childTei =\n        childTeis[`${childOrgUnit}-${chilProgram}-${personUuid}`]\n          ?.trackedEntity;\n      console.log({ parentTei, childTei });\n      const mappings = [];\n      const sharedMapping = {\n        trackedEntityType: \"cHlzCA2MuEF\",\n        attributes: [\n          {\n            attribute: \"Dggll4f9Efj\", //education\n            value: optsMap.find(\n              (o) => o[\"value.display - Answers\"] === answer.value.display\n            )?.[\"DHIS2 Option Code\"], //map to DHIS2 Option Code in optsMap\n          },\n        ],\n      };\n      if (!childTei) {\n        console.log(\"No TEI found for person\", answer.person.uuid);\n      }\n\n      if (parentTei) {\n        mappings.push({\n          trackedEntityInstance: parentTei,\n          program,\n          orgUnit,\n          ...sharedMapping,\n        });\n      }\n      if (childTei) {\n        mappings.push({\n          trackedEntityInstance: childTei,\n          program: chilProgram,\n          orgUnit: childOrgUnit,\n          ...sharedMapping,\n        });\n      }\n\n      return mappings;\n    })\n    .filter(Boolean)\n    .flat();\n\n  return {\n    ...next,\n    teisToUpdate: [...genderUpdated, ...educationUpdated],\n  };\n});\n\nfnIf(\n  (state) => state.teisToUpdate.length === 0,\n  ({ lastRunDateTime }) => ({ lastRunDateTime })\n);\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Update-TEIs": {
          "id": "3d50b0ba-7959-4a1b-8468-99ffd140a2ba",
          "name": "Update TEIs",
          "body": "// Update TEIs\ncreate(\n  \"tracker\",\n  { trackedEntities: $.teisToUpdate },\n  { params: { async: false, importStrategy: \"UPDATE\" } }\n);\n\nfn(({ lastRunDateTime }) => ({ lastRunDateTime }));\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Event-Mappings": {
          "id": "c31699da-9417-464f-84de-b3295a49720b",
          "name": "Event Mappings",
          "body": "const findAnswerByConcept = (encounter, conceptUuid) => {\n  const answer = encounter.obs.find((o) => o.concept.uuid === conceptUuid);\n  return answer?.value?.display;\n};\n\n// Helper functions for finding observations\nconst findObsByConcept = (encounter, conceptUuid) => {\n  const [conceptId, questionId] = conceptUuid.split(\"-rfe-\");\n  const answer = encounter.obs.find(\n    (o) =>\n      o.concept.uuid === conceptId &&\n      (questionId ? o.formFieldPath === `rfe-${questionId}` : true)\n  );\n  return answer;\n};\n\nconst filterObsByConcept = (encounter, conceptUuid) => {\n  const [conceptId, questionId] = conceptUuid.split(\"-rfe-\");\n  const answers = encounter.obs.filter(\n    (o) =>\n      o.concept.uuid === conceptId &&\n      (questionId ? o.formFieldPath === `rfe-${questionId}` : true)\n  );\n  return answers;\n};\n\nfunction mapF11(encounter, optsMap) {\n  if (encounter.form.description.includes(\"F11-Family Planning Assessment\")) {\n    const answers = encounter.obs.filter(\n      (o) => o.concept.uuid === \"30b2d692-6a05-401f-8ede-13e027b8a436\"\n    );\n\n    const mappingConfig = [\n      { dataElement: \"DYTLOoEKRas\", index: 0 },\n      { dataElement: \"ddTrzQtQUGz\", index: 1 },\n      { dataElement: \"fuNs3Uzspsm\", index: 2 },\n    ];\n\n    return mappingConfig.map((config) => {\n      if (answers[config.index]) {\n        return {\n          dataElement: config.dataElement,\n          value: optsMap.find(\n            (o) =>\n              o[\"value.display - Answers\"] ===\n              answers[config.index]?.value?.display\n          )?.[\"DHIS2 Option Code\"],\n        };\n      }\n    });\n  }\n}\nfunction mapF13(encounter, optsMap) {\n  if (encounter.form.description.includes(\"F13-PNC\")) {\n    const answers = encounter.obs.filter(\n      (o) => o.concept.uuid === \"22809b19-54ca-4d88-8d26-9577637c184e\"\n    );\n\n    // Define mapping configurations\n    const mappingConfig = [\n      { dataElement: \"ErtqJsZINyX\", index: 0 },\n      { dataElement: \"wWAMdsjks50\", index: 1 },\n      { dataElement: \"Dh1ocjojOrC\", index: 2 },\n      { dataElement: \"KR03PHkzVw1\", index: 3 },\n      { dataElement: \"kDA55sgLAwY\", index: 4 },\n    ];\n\n    // Only add mappings for answers that exist\n    return mappingConfig.map((config) => {\n      if (answers[config.index] !== undefined) {\n        return {\n          dataElement: config.dataElement,\n          value: optsMap.find(\n            (o) =>\n              o[\"value.display - Answers\"] ===\n              answers[config.index]?.value?.display\n          )?.[\"DHIS2 Option Code\"],\n        };\n      }\n    });\n  }\n}\n\nfunction mapF16(encounter) {\n  const answers = encounter.obs.filter(\n    (o) => o.concept.uuid === \"877aa979-c02f-4890-8156-836d52696f09\"\n  );\n\n  if (encounter.form.description.includes(\"F16-Operative Report\") && answers) {\n    const [date, time] = encounter.encounterDatetime.split(\"T\");\n    return [\n      {\n        dataElement: \"ZQgbPvQ7dWC\",\n        value: date,\n      },\n      {\n        dataElement: \"onsyxszD8X7\",\n        value: time,\n      },\n    ];\n  }\n  return;\n}\n\nfunction mapF17(encounter) {\n  const mappings = [];\n  if (\n    encounter.form.description.includes(\"F17-Surgery Admission\") &&\n    findObsByConcept(encounter, \"13d4d6b8-0cd3-46c5-be7b-c3a7565aaca7\")\n  ) {\n    mappings.push({\n      dataElement: \"hMqZO0MIIT1\",\n      value: \"hours\",\n    });\n  }\n  if (\n    encounter.form.description.includes(\"F17-Surgery Admission\") &&\n    findObsByConcept(encounter, \"7f00c65d-de60-467a-8964-fe80c7a85ef0\")\n  ) {\n    const [date, time] = encounter.encounterDatetime.split(\"T\");\n    mappings.push(\n      {\n        dataElement: \"DEGa7RaIDTo\",\n        value: date,\n      },\n      {\n        dataElement: \"aUSp8oQZIWu\",\n        value: date,\n      },\n      {\n        dataElement: \"mDOUf2zzwS2\",\n        value: time,\n      }\n    );\n  }\n  return mappings;\n}\n\nfunction mapF18(encounter, encounters) {\n  const isDischarge = findObsByConcept(\n    encounter,\n    \"13cea1c8-e426-411f-95b4-33651fc4325d\"\n  );\n\n  if (\n    encounter.form.description.includes(\"F18-Surgery Discharge\") &&\n    isDischarge\n  ) {\n    const lastAdmission = formEncounters(\"F17-Surgery Admission\", encounters)\n      .at(-1)\n      ?.encounterDatetime.replace(\"+0000\", \"\");\n    return [\n      {\n        dataElement: \"zt3Ocipob8I\",\n        value: lastAdmission,\n      },\n    ];\n  }\n}\n\nfunction mapF22(encounter) {\n  const answers = filterObsByConcept(\n    encounter,\n    \"38d5dcf5-b8bf-420e-bb14-a270e1f518b3\"\n  ).map((o) => o.value.display);\n\n  if (answers.length === 0) {\n    return;\n  }\n  // Define mapping configurations\n  const mappingConfig = [\n    { dataElement: \"y5EEruMtgG1\", has: \"None\" },\n    { dataElement: \"SqCZBLTRSt7\", has: \"Ventilation\" },\n    { dataElement: \"hW2US5pqO9c\", has: \"Cardiac massage\" },\n    { dataElement: \"ZgzXA4TjsDg\", has: \"Adrenaline\" },\n    { dataElement: \"BYxj9JiIETF\", has: \"Other\" },\n  ];\n\n  return mappingConfig\n    .map((config) => {\n      if (answers.some((a) => a.includes(config.has))) {\n        return {\n          dataElement: config.dataElement,\n          value: true,\n        };\n      }\n    })\n    .filter(Boolean);\n}\n\nfunction mapF29(encounter, optsMap) {\n  const CONCEPTS = {\n    OTHER_SPECIFY: \"e08d532b-e56c-43dc-b831-af705654d2dc\",\n    PRECIPITATING_EVENT_OTHER: \"790b41ce-e1e7-11e8-b02f-0242ac130002\", // Todo: no used anywhere\n  };\n  const mappings = [];\n  if (encounter.form.description.includes(\"F29-MHPSS Baseline v2\")) {\n    mappings.push({\n      dataElement: \"pN4iQH4AEzk\",\n      value: findAnswerByConcept(\n        encounter,\n        \"22809b19-54ca-4d88-8d26-9577637c184e\"\n      )\n        ? true\n        : false,\n    });\n\n    const priority1 = findObsByConcept(\n      encounter,\n      \"45b39cbf-0fb2-4682-8544-8aaf3e07a744\"\n    );\n    if (priority1 && priority1?.value?.display === \"Other\") {\n      mappings.push({\n        dataElement: \"pj5hIE6iyAR\",\n        value: findObsByConcept(encounter, CONCEPTS.OTHER_SPECIFY)?.value,\n      });\n    }\n\n    const priority2 = findObsByConcept(\n      encounter,\n      \"ee1b7973-e931-494e-a9cb-22b814b4d8ed\"\n    );\n    if (priority2 && priority2?.value?.display === \"Other\") {\n      mappings.push({\n        dataElement: \"Em5zvpdd5ha\",\n        value: findObsByConcept(encounter, CONCEPTS.OTHER_SPECIFY)?.value,\n      });\n    }\n\n    const priority3 = findObsByConcept(\n      encounter,\n      \"92a92f62-3ff6-4944-9ea9-a7af23949bad\"\n    );\n    if (priority3 && priority3?.value?.display === \"Other\") {\n      mappings.push({\n        dataElement: \"aWsxYkJR8Ua\",\n        value: findObsByConcept(encounter, CONCEPTS.OTHER_SPECIFY)?.value,\n      });\n    }\n\n    const precipitatingEvent1 = findObsByConcept(\n      encounter,\n      \"d5e3d927-f7ce-4fdd-ac4e-6ad0b510b608\"\n    );\n    const otherValue = encounter.obs.find((o) =>\n      o.display.includes(\"Past / Precipitating Events - Other\")\n    );\n\n    if (\n      precipitatingEvent1 &&\n      precipitatingEvent1?.value?.uuid === otherValue?.value?.uuid\n    ) {\n      const opt = optsMap.find(\n        (o) => o[\"value.uuid - External ID\"] === otherValue?.value?.uuid\n      );\n\n      mappings.push({\n        dataElement: \"m8qis4iUOTo\",\n        value: opt?.[\"DHIS2 Option Code\"],\n      });\n    }\n\n    const precipitatingEvent2 = findObsByConcept(\n      encounter,\n      \"54a9b20e-bce5-4d4a-8c9c-e0248a182586\"\n    );\n\n    if (\n      precipitatingEvent2 &&\n      precipitatingEvent2?.value?.uuid === otherValue?.value?.uuid\n    ) {\n      const opt = optsMap.find(\n        (o) => o[\"value.uuid - External ID\"] === otherValue?.value?.uuid\n      );\n      mappings.push({\n        dataElement: \"mNK6CITsdWD\",\n        value: opt?.[\"DHIS2 Option Code\"],\n      });\n    }\n\n    const precipitatingEvent3 = findObsByConcept(\n      encounter,\n      \"e0d4e006-85b5-41cb-8a21-e013b1978b8b\"\n    );\n\n    if (\n      precipitatingEvent3 &&\n      precipitatingEvent3?.value?.uuid === otherValue?.uuid\n    ) {\n      const opt = optsMap.find(\n        (o) => o[\"value.uuid - External ID\"] === otherValue?.value?.uuid\n      );\n      mappings.push({\n        dataElement: \"jocqmYW394G\",\n        value: opt?.[\"DHIS2 Option Code\"],\n      });\n    }\n  }\n  return mappings;\n}\n\nfunction mapF30F29(encounter, allEncounters) {\n  if (encounter.form.description.includes(\"F30-MHPSS Follow-up v2\")) {\n    const missedSession = (encounter) => {\n      if (\n        encounter.obs.find(\n          (o) => o.concept.uuid === \"54e8c1b6-6397-4822-89a4-cf81fbc68ce9\"\n        )?.value?.display === \"No\"\n      ) {\n        return encounter.encounterDatetime.replace(\"+0000\", \"\");\n      }\n      const lastFollowupEncounter = allEncounters.find(\n        (e) =>\n          e.form.description.includes(\"F30-MHPSS Follow-up v2\") &&\n          e.patient.uuid === encounter.patient.uuid &&\n          e.uuid !== encounter.uuid &&\n          e.obs.find(\n            (o) => o.concept.uuid === \"54e8c1b6-6397-4822-89a4-cf81fbc68ce9\"\n          )?.value?.display === \"No\"\n      );\n\n      if (lastFollowupEncounter) {\n        return lastFollowupEncounter.encounterDatetime.replace(\"+0000\", \"\");\n      }\n\n      const f29Encounter = allEncounters.find(\n        (e) =>\n          e.form.description.includes(\"F29-MHPSS Baseline v2\") &&\n          e.patient.uuid === encounter.patient.uuid\n      );\n      if (f29Encounter) {\n        return f29Encounter.encounterDatetime.replace(\"+0000\", \"\");\n      }\n      return undefined;\n    };\n    const mapping = [\n      {\n        dataElement: \"jtKIoKducvE\",\n        value: missedSession(encounter),\n      },\n    ];\n    return mapping;\n  }\n}\n\nfunction mapF32F31(encounter, allEncounters) {\n  if (encounter.form.description.includes(\"F32-mhGAP Follow-up v2\")) {\n    const missedSession = (encounter) => {\n      if (\n        encounter.obs.find(\n          (o) => o.concept.uuid === \"54e8c1b6-6397-4822-89a4-cf81fbc68ce9\"\n        )?.value?.display === \"No\"\n      ) {\n        return encounter.encounterDatetime.replace(\"+0000\", \"\");\n      }\n      const lastFollowupEncounter = allEncounters.find(\n        (e) =>\n          e.form.description.includes(\"F32-mhGAP Follow-up v2\") &&\n          e.patient.uuid === encounter.patient.uuid &&\n          e.uuid !== encounter.uuid &&\n          e.obs.find(\n            (o) => o.concept.uuid === \"54e8c1b6-6397-4822-89a4-cf81fbc68ce9\"\n          )?.value?.display === \"No\"\n      );\n\n      if (lastFollowupEncounter) {\n        return lastFollowupEncounter.encounterDatetime.replace(\"+0000\", \"\");\n      }\n\n      const f31Encounter = allEncounters.find(\n        (e) =>\n          e.form.description.includes(\"F31-mhGAP Baseline v2\") &&\n          e.patient.uuid === encounter.patient.uuid\n      );\n\n      if (f31Encounter) {\n        return f31Encounter.encounterDatetime.replace(\"+0000\", \"\");\n      }\n    };\n    const changeInDiagnosis = (encounter) => {\n      const patientUuid = encounter.patient.uuid;\n      const previousChangeInDiagnosis = allEncounters\n        .find(\n          (e) =>\n            e.patient.uuid === patientUuid &&\n            e.form.description.includes(\"F32-mhGAP Follow-up v2\") &&\n            encounter.uuid !== e.uuid\n        )\n        ?.obs.find(\n          (o) => o.concept.uuid === \"22809b19-54ca-4d88-8d26-9577637c184e\"\n        )?.value?.display;\n\n      const currentChangeInDiagnosis = encounter.obs.find(\n        (o) => o.concept.uuid === \"22809b19-54ca-4d88-8d26-9577637c184e\"\n      )?.value?.display;\n\n      if (\n        previousChangeInDiagnosis &&\n        previousChangeInDiagnosis !== currentChangeInDiagnosis\n      ) {\n        return true;\n      }\n\n      return false;\n    };\n    const mapping = [\n      {\n        dataElement: \"fMqEZpiRVZV\",\n        value: missedSession(encounter),\n      },\n      {\n        dataElement: \"XBVRRpgkEvE\",\n        value: changeInDiagnosis(encounter),\n      },\n    ];\n    return mapping;\n  }\n}\n\nfunction mapF33F34(encounter, allEncounters) {\n  if (\n    encounter.form.description.includes(\"F33-MHPSS Closure v2\") ||\n    encounter.form.description.includes(\"F34-mhGAP Closure v2\")\n  ) {\n    const lastScore = encounter.obs.find(\n      (o) => o.concept.uuid === \"90b3d09c-d296-44d2-8292-8e04377fe027\"\n    )?.value;\n\n    const filterOutScore = allEncounters.filter((e) => {\n      const obs = e.obs.find(\n        (o) => o.concept.display === \"Mental Health Outcome Scale\"\n      );\n      return e.uuid !== encounter.uuid && obs && obs?.value !== 0;\n    });\n\n    const firstScore = filterOutScore\n      .sort((a, b) => {\n        return new Date(a.encounterDatetime) - new Date(b.encounterDatetime);\n      })\n      .at(0)\n      ?.obs.find(\n        (o) => o.concept.display === \"Mental Health Outcome Scale\"\n      )?.value;\n\n    return {\n      dataElement: \"b8bjS7ah8Qi\",\n      value: lastScore - firstScore,\n    };\n  }\n}\n\nfunction mapF37(encounter) {\n  const answers = filterObsByConcept(\n    encounter,\n    \"d30db8b8-f8fb-450c-9562-629195212a45\"\n  ).map((o) => o.value.display);\n\n  if (answers.length === 0) {\n    return;\n  }\n  const mappingConfig = [\n    { dataElement: \"MATDmdd9lRR\", has: \"Medical induction\" },\n    { dataElement: \"DNQWSGBOBQB\", has: \"Unassisted induction\" },\n    { dataElement: \"ts3xCk7k7x0\", has: \"Artificial rupture of membrane\" },\n    { dataElement: \"p59TQ8PvXVH\", has: \"Dilatation and curettage\" },\n    { dataElement: \"Uby3bOB4hFn\", has: \"Prepare for C-section\" },\n    { dataElement: \"G2XoPI8Onh6\", has: \"Prepare for emergency C-section\" },\n    { dataElement: \"cLo2RytNPE9\", has: \"Deferred admission\" },\n    { dataElement: \"xB4S4ZVgAbm\", has: \"External referral\" },\n    { dataElement: \"HgexHDb2auE\", has: \"Other\" },\n  ];\n\n  const f37Mapping = mappingConfig\n    .map((config) => {\n      if (answers.some((a) => a.includes(config.has))) {\n        return {\n          dataElement: config.dataElement,\n          value: true,\n        };\n      }\n    })\n    .filter(Boolean);\n\n  console.log({ f37Mapping });\n  return f37Mapping;\n}\n\nfunction mapF38(encounter) {\n  const procedureAnswers = filterObsByConcept(\n    encounter,\n    \"482af9e6-795d-42d9-be5b-64f4df54a63e\"\n  ).map((o) => o.value.display);\n\n  const anaesthesiaAnswers = filterObsByConcept(\n    encounter,\n    \"84cc236e-90fa-4eec-acf5-d0cd6b713dc4\"\n  ).map((o) => o.value.display);\n\n  let f38Mapping = [];\n  if (procedureAnswers.length > 1) {\n    const procedureConfig = [\n      {\n        dataElement: \"JshMCeD8bNx\",\n        has: \"FGM / female circumcision management\",\n      },\n      { dataElement: \"oxXdt4qFPUT\", has: \"Episiotomy\" },\n      { dataElement: \"puJfC1hX0CN\", has: \"Induction of labor\" },\n      {\n        dataElement: \"ncgztSFld2L\",\n        has: \"Oxytocin for augmentation of labour\",\n      },\n      {\n        dataElement: \"cQsT8zdLu6s\",\n        has: \"VBAC (Vaginal birth after Caesearan)\",\n      },\n      { dataElement: \"BvfOhTNVitn\", has: \"Vaginal breech delivery\" },\n      { dataElement: \"RHSujdOFWre\", has: \"Twins / triplets vaginal delivery\" },\n      { dataElement: \"z1Bej1f1gCu\", has: \"Maneuver\" },\n      { dataElement: \"JHZVr6SECp3\", has: \"Manual exploration of uterus\" },\n      { dataElement: \"RiSel8y1SuF\", has: \"Curettage\" },\n      {\n        dataElement: \"DxnQSPcbxdF\",\n        has: \"Laceration (perineal tear) repaired\",\n      },\n      { dataElement: \"IIoljELzj95\", has: \"Cervical tear repair\" },\n      { dataElement: \"Lvk3ipAxiAH\", has: \"Tubal ligation (sterilization)\" },\n    ];\n    const procedureMapping = procedureConfig\n      .map((config) => {\n        if (procedureAnswers.some((a) => a.includes(config.has))) {\n          return {\n            dataElement: config.dataElement,\n            value: true,\n          };\n        }\n      })\n      .filter(Boolean);\n    f38Mapping.push(...procedureMapping);\n  }\n\n  if (anaesthesiaAnswers.length > 0) {\n    const anaesthesiaConfig = [\n      { dataElement: \"kjg89ETfuSW\", has: \"General\" },\n      { dataElement: \"bgauK1cE1HM\", has: \"Local\" },\n      { dataElement: \"dBAXsq3kl3p\", has: \"Spinal\" },\n    ];\n    const anaesthesiaMapping = anaesthesiaConfig\n      .map((config) => {\n        if (anaesthesiaAnswers.some((a) => a.includes(config.has))) {\n          return {\n            dataElement: config.dataElement,\n            value: true,\n          };\n        }\n      })\n      .filter(Boolean);\n    f38Mapping.push(...anaesthesiaMapping);\n  }\n\n  if (f38Mapping.length === 0) {\n    return;\n  }\n\n  console.log({ f38Mapping });\n  return f38Mapping;\n}\n\nfunction mapF55(encounter) {\n  if (encounter.form.description.includes(\"F55-HBV Baseline\")) {\n    const encounterDate = encounter.encounterDatetime.replace(\"+0000\", \"\");\n    return {\n      dataElement: \"z62bfjOA5CD\",\n      value: encounterDate,\n    };\n  }\n}\n\nfunction mapF56(encounter, metadataMap) {\n  const { events } = metadataMap;\n  const event = events?.find((e) => e.programStage === \"d5sMByjqQFm\")?.event;\n\n  return {\n    event,\n    programStage: \"d5sMByjqQFm\",\n    dataValues: [\n      {\n        dataElement: \"W450u7KdzUz\",\n        value: encounter.encounterDatetime.replace(\"+0000\", \"\"),\n      },\n      {\n        dataElement: \"WaPztwF7kGN\",\n        value: findAnswerByConcept(\n          encounter,\n          \"4f4c6be4-1e1a-4770-a73b-bcc69c171748\"\n        ),\n      },\n      {\n        dataElement: \"Gl1axYBX5gV\",\n        value: findAnswerByConcept(\n          encounter,\n          \"0f478fde-1219-4815-9481-f507e8457c38\"\n        ),\n      },\n      {\n        dataElement: \"psbKn33o6yi\",\n        value: findAnswerByConcept(\n          encounter,\n          \"ef0b1e26-411e-40d5-bd98-8762f92c22d0\"\n        ),\n      },\n    ],\n  };\n}\n\nfunction mapF58(encounter, metadataMap) {\n  const { events } = metadataMap;\n  const event = events?.find((e) => e.programStage === \"Rd73a6zlYEy\")?.event;\n\n  return {\n    event,\n    programStage: \"Rd73a6zlYEy\",\n    dataValues: [\n      {\n        dataElement: \"gn40F7cEQTI\",\n        value: encounter.encounterDatetime.replace(\"+0000\", \"\"),\n      },\n      {\n        dataElement: \"rmYRcxE5I5G\",\n        value: findAnswerByConcept(\n          encounter,\n          \"0f478fde-1219-4815-9481-f507e8457c38\"\n        ),\n      },\n    ],\n  };\n}\n\nfunction mapF59(encounter, metadataMap) {\n  const { events } = metadataMap;\n\n  const event = events?.find((e) => e.programStage === \"sBepdVG2c9O\")?.event;\n\n  const typeOfIncome = findAnswerByConcept(\n    encounter,\n    \"f501e482-d6cd-45d7-be5d-ef6e09461380\"\n  );\n\n  const usedDrug = findAnswerByConcept(\n    encounter,\n    \"30837713-453e-4456-ac48-b3886acf02ac\"\n  );\n  const typeOfExit = findObsByConcept(\n    encounter,\n    \"4f4c6be4-1e1a-4770-a73b-bcc69c171748\"\n  );\n\n  const typeOfExitOther = findObsByConcept(\n    encounter,\n    \"790b41ce-e1e7-11e8-b02f-0242ac130002\"\n  );\n\n  return {\n    event,\n    programStage: \"sBepdVG2c9O\",\n    dataValues: [\n      {\n        dataElement: \"Nfd45uVy6lc\",\n        value: [\"full time\", \"part time\"].some((keyword) =>\n          typeOfIncome.toLowerCase().includes(keyword)\n        )\n          ? \"Employment\"\n          : null,\n      },\n\n      {\n        dataElement: \"Ir0qLWsNv4n\",\n        value: [\"in the past\", \"currently\"].some((keyword) =>\n          usedDrug.toLowerCase().includes(keyword)\n        )\n          ? \"Yes\"\n          : \"No\",\n      },\n      {\n        dataElement: \"JvgfNjNklmI\",\n        value: encounter.encounterDatetime.replace(\"+0000\", \"\"),\n      },\n      {\n        dataElement: \"LhgHv4gjW18\",\n        value: typeOfExit?.value?.display,\n      },\n      {\n        dataElement: \"k64e6bcyPtH\",\n        value: typeOfExitOther?.value?.display,\n      },\n    ],\n  };\n}\n\nfunction mapF60(encounter, metadataMap) {\n  const { events } = metadataMap;\n  const event = events?.find((e) => e.programStage === \"sBepdVG2c9O\")?.event;\n  const typeOfExit = findObsByConcept(\n    encounter,\n    \"4f4c6be4-1e1a-4770-a73b-bcc69c171748\"\n  );\n\n  const typeOfExitOther = findObsByConcept(\n    encounter,\n    \"790b41ce-e1e7-11e8-b02f-0242ac130002\"\n  );\n  return {\n    event,\n    programStage: \"sBepdVG2c9O\",\n    dataValues: [\n      {\n        dataElement: \"JvgfNjNklmI\",\n        value: encounter.encounterDatetime.replace(\"+0000\", \"\"),\n      },\n      {\n        dataElement: \"LhgHv4gjW18\",\n        value: typeOfExit?.value?.display,\n      },\n      {\n        dataElement: \"k64e6bcyPtH\",\n        value: typeOfExitOther?.value?.display,\n      },\n    ],\n  };\n}\n\nconst conceptAndValue = (encounter, conceptUuid, valueUuid) => {\n  const answer = encounter.obs.find(\n    (o) => o.concept.uuid === conceptUuid && o.value.uuid === valueUuid\n  );\n  return answer ? \"TRUE\" : \"FALSE\";\n};\nconst conceptNotValue = (encounter, conceptUuid, valueUuid) => {\n  const answer = encounter.obs.find(\n    (o) => o.concept.uuid === conceptUuid && o.value.uuid !== valueUuid\n  );\n  return answer ? \"TRUE\" : \"FALSE\";\n};\nfunction mapF61(encounter, metadataMap) {\n  const { events } = metadataMap;\n  const event = events?.find((e) => e.programStage === \"y8MvLYtuKE3\")?.event;\n\n  return {\n    event,\n    programStage: \"y8MvLYtuKE3\",\n    dataValues: [\n      {\n        dataElement: \"wqSAGFM1Oz8\",\n        value: conceptNotValue(\"2ff0d1ad-df05-4128-b2d2-d72307a6aa3f\"),\n      },\n      {\n        dataElement: \"M7aqCkQSnIP\",\n        value: conceptAndValue(\n          \"2ff0d1ad-df05-4128-b2d2-d72307a6aa3f\",\n          \"95ac8931-7222-4d14-9d94-2e55074e6261\"\n        ),\n      },\n      {\n        dataElement: \"H6mrPZ2PvGa\",\n        value: conceptAndValue(\n          \"2ff0d1ad-df05-4128-b2d2-d72307a6aa3f\",\n          \"a257d08e-b90d-4505-91c3-e23ea040f61c\"\n        ),\n      },\n      {\n        dataElement: \"aHEgOilU4Sg\",\n        value: conceptAndValue(\n          \"2ff0d1ad-df05-4128-b2d2-d72307a6aa3f\",\n          \"02e8a7bc-d18c-4650-bf47-c8e52f493f3b\"\n        ),\n      },\n      {\n        dataElement: \"I64ENhlDzP6\",\n        value: conceptAndValue(\n          \"2ff0d1ad-df05-4128-b2d2-d72307a6aa3f\",\n          \"a6fe73a2-0352-4104-82a7-4456f1866c1e\"\n        ),\n      },\n      {\n        dataElement: \"i69GqSWXwRZ\",\n        value: conceptAndValue(\n          \"2ff0d1ad-df05-4128-b2d2-d72307a6aa3f\",\n          \"9f50dc11-9ed4-4e25-a059-9cb770651c35\"\n        ),\n      },\n      {\n        dataElement: \"KGwTrsJjYR5\",\n        value: conceptNotValue(\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\",\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\"\n        ),\n      },\n      {\n        dataElement: \"G10cJ5RJ2uE\",\n        value: conceptNotValue(\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\",\n          \"04684645-508f-4ec4-91a9-406e5567a934\"\n        ),\n      },\n      {\n        dataElement: \"Yp6qfnhSbTx\",\n        value: conceptNotValue(\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\",\n          \"e81a13a6-d469-465d-9c6b-9930c7bb7d39\"\n        ),\n      },\n      {\n        dataElement: \"LgoaYXv2mkO\",\n        value: conceptNotValue(\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\",\n          \"05aa3b94-7e7e-47f1-80b9-1304889c293c\"\n        ),\n      },\n      {\n        dataElement: \"ScHhUDsY1JM\",\n        value: conceptNotValue(\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\",\n          \"b10b22e3-a46d-4682-aba5-fdeac3591d29\"\n        ),\n      },\n      {\n        dataElement: \"vKTI1wQhhy7\",\n        value: conceptNotValue(\n          \"ebb50467-1a62-41f0-a849-2ec0ed49607a\",\n          \"67322e0a-0def-4543-97cd-89cdd03e2950\"\n        ),\n      },\n      {\n        dataElement: \"qrcrEVE5vOL\",\n        value: () => {\n          const hasConceptId = (conceptId) =>\n            encounter.obs.some((o) => o.concept.uuid === conceptId);\n          const notValueId = (valueUuid) =>\n            encounter.obs.find((o) => o.value.uuid !== valueUuid);\n          if (\n            hasConceptId(\"d0e31c9b-fb6b-4d8b-9c54-c8410c719f1c\") &&\n            notValueId(\"1eff97cc-bec8-4bdf-9022-dc0f2132c260\")\n          ) {\n            return \"By road\";\n          }\n          if (\n            hasConceptId(\"d0e31c9b-fb6b-4d8b-9c54-c8410c719f1c\") &&\n            notValueId(\"8c5d6c46-1712-483f-91db-c6a9db213c50\")\n          ) {\n            return \"By plane\";\n          }\n          if (\n            hasConceptId(\"d0e31c9b-fb6b-4d8b-9c54-c8410c719f1c\") &&\n            notValueId(\"1eff97cc-bec8-4bdf-9022-dc0f2132c260\") &&\n            notValueId(\"a31cd4a6-a02b-490b-b913-59cbc8f305f8\")\n          ) {\n            return \"By road and boat\";\n          }\n\n          if (\n            hasConceptId(\"d0e31c9b-fb6b-4d8b-9c54-c8410c719f1c\") &&\n            notValueId(\"1eff97cc-bec8-4bdf-9022-dc0f2132c260\") &&\n            notValueId(\"8c5d6c46-1712-483f-91db-c6a9db213c50\")\n          ) {\n            return \"By road and plane\";\n          }\n\n          if (\n            hasConceptId(\"d0e31c9b-fb6b-4d8b-9c54-c8410c719f1c\") &&\n            notValueId(\"b10b22e3-a46d-4682-aba5-fdeac3591d29\") &&\n            notValueId(\"8c5d6c46-1712-483f-91db-c6a9db213c50\")\n          ) {\n            return \"By boat and plane\";\n          }\n\n          if (\n            hasConceptId(\"d0e31c9b-fb6b-4d8b-9c54-c8410c719f1c\") &&\n            notValueId(\"1eff97cc-bec8-4bdf-9022-dc0f2132c260\") &&\n            notValueId(\"a31cd4a6-a02b-490b-b913-59cbc8f305f8\") &&\n            notValueId(\"8c5d6c46-1712-483f-91db-c6a9db213c50\")\n          ) {\n            return \"By road, boat and plane\";\n          }\n          if (\n            hasConceptId(\"d30db8b8-f8fb-450c-9562-629195212a45\") &&\n            notValueId(\"a6fe73a2-0352-4104-82a7-4456f1866c1e\")\n          ) {\n            return true;\n          }\n        },\n      },\n      {\n        dataElement: \"gJoiya16c1E\",\n        value: conceptNotValue(\n          \"d30db8b8-f8fb-450c-9562-629195212a45\",\n          \"a6fe73a2-0352-4104-82a7-4456f1866c1e\"\n        ),\n      },\n      {\n        dataElement: \"aHEgOilU4Sg\",\n        value: conceptNotValue(\n          \"d30db8b8-f8fb-450c-9562-629195212a45\",\n          \"02e8a7bc-d18c-4650-bf47-c8e52f493f3b\"\n        ),\n      },\n      {\n        dataElement: \"ahGVTDSbSaq\",\n        value: conceptNotValue(\n          \"d30db8b8-f8fb-450c-9562-629195212a45\",\n          \"a257d08e-b90d-4505-91c3-e23ea040f61c\"\n        ),\n      },\n      {\n        dataElement: \"i69GqSWXwRZ\",\n        value: conceptNotValue(\n          \"d30db8b8-f8fb-450c-9562-629195212a45\",\n          \"9f50dc11-9ed4-4e25-a059-9cb770651c35\"\n        ),\n      },\n      {\n        dataElement: \"Sp0VsyyvDCI\",\n        value: conceptNotValue(\n          \"96d32363-694a-4d6a-9710-6ceadd0e2894\",\n          \"4a946686-7d67-40d5-b1f1-a0aad133193c\"\n        ),\n      },\n      {\n        dataElement: \"JNNfaYcPPuS\",\n        value: conceptNotValue(\n          \"96d32363-694a-4d6a-9710-6ceadd0e2894\",\n          \"9de0f8c5-df5c-4fc2-a586-48acd7219e04\"\n        ),\n      },\n      {\n        dataElement: \"awIYcHfNEnI\",\n        value: conceptNotValue(\n          \"96d32363-694a-4d6a-9710-6ceadd0e2894\",\n          \"0254978b-c858-4b9d-ba66-074ced37a6d5\"\n        ),\n      },\n      {\n        dataElement: \"xjG5N6RD9vm\",\n        value: conceptNotValue(\n          \"96d32363-694a-4d6a-9710-6ceadd0e2894\",\n          \"e48a7343-bbc1-4e83-85ab-87e267f15cec\"\n        ),\n      },\n      {\n        dataElement: \"Lj15WiOE5Jj\",\n        value: conceptNotValue(\n          \"96d32363-694a-4d6a-9710-6ceadd0e2894\",\n          \"2b616aa9-e573-40a1-8e01-dfdde229553b\"\n        ),\n      },\n    ],\n  };\n}\n\nfunction mapF62(encounter, metadataMap) {\n  const { events } = metadataMap;\n\n  const hospitalisationEvent = {\n    event: events?.find((e) => e.programStage === \"YivvTlIw5Ep\")?.event,\n    programStage: \"YivvTlIw5Ep\",\n    dataValues: [\n      {\n        dataElement: \"d3BwrZYHAbK\",\n        value: encounter.encounterDatetime\n          .replace(\"+0000\", \"\")\n          .substring(11, 19),\n      },\n      {\n        dataElement: \"RSQqK2yZGz6\",\n        value: findAnswerByConcept(\n          encounter,\n          \"c149755e-dd32-43b0-b643-ab14aa483207\"\n        ),\n      },\n      {\n        dataElement: \"NHBJjpIXPBI\",\n        value: findAnswerByConcept(\n          encounter,\n          \"b996944c-b136-4e8e-9068-562476a0595a\"\n        ),\n      },\n      {\n        dataElement: \"LPIyv58pWVg\",\n        value: findAnswerByConcept(\n          encounter,\n          \"13cea1c8-e426-411f-95b4-33651fc4325d\"\n        ),\n      },\n      {\n        dataElement: \"nrqutHXxAUk\",\n        value: findAnswerByConcept(\n          encounter,\n          \"09a06404-afc5-457a-91b9-54152e45a854\"\n        ),\n      },\n      {\n        dataElement: \"dNJ9ZJ4zaJw\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"895813df-fbec-4164-9375-eed588ff0387\"\n        ),\n      },\n      {\n        dataElement: \"KlAcesRNOlU\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"bfcf416f-8aa1-4b9d-a0f7-77c142c1df67\"\n        ),\n      },\n      {\n        dataElement: \"pP8Bb7H0arh\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"10156771-379a-4eb1-af43-39b418adba4a\"\n        ),\n      },\n      {\n        dataElement: \"fKmCFuaV2wo\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"14e79fdc-4250-428f-949e-dabb2cef4315\"\n        ),\n      },\n      {\n        dataElement: \"oOa893M9qnL\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"a39e540e-b988-40e8-a8b2-26b831c179ef\"\n        ),\n      },\n      {\n        dataElement: \"rDJiUSUtmrg\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"c884bf19-6791-4c38-af6b-1ad910191a89\"\n        ),\n      },\n      {\n        dataElement: \"PG9mocTexDK\",\n        value: conceptNotValue(\n          \"6b3cf530-e574-419a-9dd4-2c8d3ad69562\",\n          \"d592dcaf-ae83-4acc-921e-127aa27545b5\"\n        )\n          ? \"Dressing\"\n          : null,\n      },\n    ],\n  };\n\n  const exitEvent = {\n    event: events?.find((e) => e.programStage === \"Otoff7Cj8JQ\")?.event,\n    programStage: \"Otoff7Cj8JQ\",\n    dataValues: [\n      {\n        dataElement: \"iGsz0Q3b0HC\",\n        value: findAnswerByConcept(\n          encounter,\n          \"1f473371-613f-4ef3-b297-49eb779ccd27\"\n        ),\n      },\n      {\n        dataElement: \"mpiPBwCu6Xa\",\n        value: findAnswerByConcept(\n          encounter,\n          \"9e861ef1-e07c-4955-9650-2ebac3138fc3\"\n        ),\n      },\n      {\n        dataElement: \"d8eoys0WPgR\",\n        value: findAnswerByConcept(\n          encounter,\n          \"a844ff25-b3fb-4873-9681-f2f35f5159ec\"\n        ),\n      },\n      {\n        dataElement: \"p1t7OpwVBcl\",\n        value: findAnswerByConcept(\n          encounter,\n          \"778b70b5-c6de-4459-a101-6bf02f77d5c7\"\n        ),\n      },\n    ],\n  };\n  const f62Events = [hospitalisationEvent, exitEvent];\n\n  return f62Events;\n}\n\nfunction mapF63(encounter, metadataMap) {\n  return mapF62(encounter, metadataMap); // TODO @Aisha to confirm with ludovic\n}\n\nconst findDataValue = (encounter, dataElement, metadataMap) => {\n  const { optsMap, optionSetKey, form } = metadataMap;\n  const [conceptUuid, questionId] =\n    form.dataValueMap[dataElement]?.split(\"-rfe-\") || [];\n  const answer = encounter.obs.find((o) => o.concept.uuid === conceptUuid);\n  const isObjectAnswer = answer && typeof answer.value === \"object\";\n  const isStringAnswer = answer && typeof answer.value === \"string\";\n  const isNumberAnswer = answer && typeof answer.value === \"number\";\n\n  if (isStringAnswer || isNumberAnswer) {\n    return answer.value;\n  }\n\n  if (\n    isObjectAnswer &&\n    conceptUuid === \"722dd83a-c1cf-48ad-ac99-45ac131ccc96\" &&\n    dataElement === \"pN4iQH4AEzk\"\n  ) {\n    console.log(\"Yes done by psychologist..\");\n    return \"\" + answer.value.uuid === \"278401ee-3d6f-4c65-9455-f1c16d0a7a98\";\n  }\n\n  if (\n    isObjectAnswer &&\n    conceptUuid === \"54e8c1b6-6397-4822-89a4-cf81fbc68ce9\" &&\n    dataElement === \"G0hLyxqgcO7\"\n  ) {\n    console.log(\"True only question detected..\", dataElement);\n    return answer.value.uuid === \"681cf0bc-5213-492a-8470-0a0b3cc324dd\"\n      ? \"true\"\n      : undefined;\n  }\n\n  if (isObjectAnswer) {\n    const optionKey = questionId\n      ? `${encounter.form.uuid}-${answer.concept.uuid}-rfe-${questionId}`\n      : `${encounter.form.uuid}-${answer.concept.uuid}`;\n\n    const matchingOptionSet = optionSetKey[optionKey];\n    console.log(\"matchingOptionSet:\", matchingOptionSet);\n    console.log(\"Answer:\", answer.value.uuid);\n\n    const opt = optsMap.find(\n      (o) =>\n        o[\"value.uuid - External ID\"] === answer.value.uuid &&\n        o[\"DHIS2 Option Set UID\"] === matchingOptionSet\n    );\n\n    console.log(\"Opt:\", opt);\n    const matchingOption =\n      opt?.[\"DHIS2 Option Code\"] ||\n      opt?.[\"DHIS2 Option name\"] || // TODO: Sync with AK: We have added this because  Opticon Code is empty in some cases.\n      answer?.value?.display; //TODO: revisit this logic if optionSet not found\n    if (!opt) {\n      console.log(\n        `No opt found for External id ${answer.value.uuid} and DHIS2 OptionSet ${matchingOptionSet}`\n      );\n    }\n    if (matchingOption !== opt?.[\"DHIS2 Option Code\"]) {\n      console.log(\n        `No DHIS2 Option Code found for External id ${answer.value.uuid} and DHIS2 OptionSet ${matchingOptionSet}`\n      );\n    }\n\n    if ([\"FALSE\", \"No\"].includes(matchingOption)) return \"false\";\n    if ([\"TRUE\", \"Yes\"].includes(matchingOption)) return \"true\";\n\n    return matchingOption;\n  }\n\n  const isEncounterDate =\n    conceptUuid === \"encounter-date\" &&\n    [\"CXS4qAJH2qD\", \"I7phgLmRWQq\", \"yUT7HyjWurN\", \"EOFi7nk2vNM\"].includes(\n      dataElement\n    );\n\n  // These are data elements for encounter date in DHIS2\n  // F29 MHPSS Baseline v2, F31-mhGAP Baseline v2, F30-MHPSS Follow-up v2, F32-mhGAp Follow-up v2\n  if (isEncounterDate) {\n    return encounter.encounterDatetime.replace(\"+0000\", \"\");\n  }\n\n  return \"\";\n};\n\nconst formEncounters = (formDescription, encounters) => {\n  return encounters.filter((e) => e.form.description.includes(formDescription));\n};\n\nconst buildExitEvent = (encounter, tei) => {\n  const { program, orgUnit, trackedEntity, enrollment, events } = tei;\n\n  let exitEvent = null;\n  const mapping = {\n    program,\n    orgUnit,\n    trackedEntity,\n    enrollment,\n    occurredAt: encounter.encounterDatetime.replace(\"+0000\", \"\"),\n  };\n\n  if (encounter.form.description.includes(\"F56-HBV Follow-up\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF56(encounter, { events }),\n    };\n  }\n  if (encounter.form.description.includes(\"F58-HCV Follow-up\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF58(encounter, { events }),\n    };\n  }\n  if (encounter.form.description.includes(\"F59-Social Work Baseline\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF59(encounter, { events }),\n    };\n  }\n  if (encounter.form.description.includes(\"F60-Social Work Follow-up\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF60(encounter, { events }),\n    };\n  }\n  if (encounter.form.description.includes(\"F61-Travel medicine\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF61(encounter, { events }),\n    };\n  }\n  if (encounter.form.description.includes(\"F62-Palliative care Baseline\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF62(encounter, { events }),\n    };\n  }\n  if (encounter.form.description.includes(\"F63-Palliative care Follow-up\")) {\n    exitEvent = {\n      ...mapping,\n      ...mapF63(encounter, { events }),\n    };\n  }\n\n  return exitEvent;\n};\n// Prepare DHIS2 data model for create events\nfn((state) => {\n  const handleMissingRecord = (data, state) => {\n    const { uuid, display } = data.patient;\n\n    console.log(uuid, \"Patient is missing trackedEntity or enrollment\");\n\n    state.missingRecords ??= {};\n    state.missingRecords[uuid] ??= {\n      encounters: [],\n      patient: display,\n    };\n\n    state.missingRecords[uuid].encounters.push(data.uuid);\n  };\n\n  state.eventsMapping = state.encounters\n    .map((encounter) => {\n      const form = state.formMaps[encounter.form.uuid];\n      if (!form?.dataValueMap) {\n        return null;\n      }\n      const program = state.formMaps[encounter.form.uuid].programId;\n      const orgUnit = state.formMaps[encounter.form.uuid].orgUnit;\n      const patientOuProgram = `${orgUnit}-${program}-${encounter.patient.uuid}`;\n      const { trackedEntity, enrollment, events } =\n        state.childTeis[patientOuProgram] || {};\n\n      if (!trackedEntity || !enrollment) {\n        handleMissingRecord(encounter, state);\n        return null;\n      }\n      let formDataValues = Object.keys(form.dataValueMap)\n        .map((dataElement) => {\n          const value = findDataValue(encounter, dataElement, {\n            optsMap: state.optsMap,\n            optionSetKey: state.optionSetKey,\n            form,\n          });\n\n          return { dataElement, value };\n        })\n        .filter(\n          ({ dataElement, value }) =>\n            value &&\n            ![\"pj5hIE6iyAR\", \"KjgDauY9v4J\", \"DYTLOoEKRas\"].includes(dataElement)\n        );\n\n      const customMapping = [\n        mapF11(encounter, state.optsMap),\n        mapF13(encounter, state.optsMap),\n        mapF18(encounter, state.encounters),\n        mapF16(encounter),\n        mapF17(encounter),\n        mapF29(encounter, state.optsMap),\n        mapF22(encounter),\n        mapF37(encounter),\n        mapF38(encounter),\n        mapF30F29(encounter, state.allEncounters),\n        mapF32F31(encounter, state.allEncounters),\n        mapF33F34(encounter, state.allEncounters),\n      ]\n        .filter(Boolean) // Only include non-empty mappings\n        .flat(); // flattening the array\n\n      const formEvent = {\n        event: events?.find((e) => e.programStage === form.programStage)?.event,\n        program,\n        orgUnit,\n        trackedEntity,\n        enrollment,\n        occurredAt: encounter.encounterDatetime.replace(\"+0000\", \"\"),\n        programStage: form.programStage,\n        dataValues: [...formDataValues, ...customMapping].filter(\n          (d) => d?.value\n        ),\n      };\n\n      const exitFormEvent = buildExitEvent(encounter, {\n        program,\n        orgUnit,\n        trackedEntity,\n        enrollment,\n        events,\n      });\n\n      const mappings = [formEvent, exitFormEvent];\n\n      return mappings;\n    })\n    .flat()\n    .filter(Boolean);\n\n  return state;\n});\n\nfn((state) => {\n  return { eventMapping: state.eventsMapping };\n});\n",
          "adaptor": "@openfn/language-common@2.1.1",
          "project_credential_id": null
        },
        "Create-TEIs-Relationship": {
          "id": "ff3980d5-2f46-41f0-8d63-ccb63328325d",
          "name": "Create TEIs Relationship",
          "body": "fn((state) => {\n  state.relationshipsMapping = Object.values(state.childTeis)\n    .map((tei) => {\n      const omrsPatientUuid = tei?.attributes.find(\n        ({ attribute }) => attribute === \"AYbfTPYMNJH\"\n      )?.value;\n\n      const childTei = tei?.trackedEntity;\n      const parentTei = state.parentTeis[omrsPatientUuid]?.trackedEntity;\n      const relationshipType = tei?.relationshipType;\n\n      if (childTei != parentTei) {\n        return {\n          from: {\n            trackedEntityInstance: {\n              trackedEntityInstance: parentTei,\n            },\n          },\n          to: {\n            trackedEntityInstance: {\n              trackedEntityInstance: childTei,\n            },\n          },\n          relationshipType,\n        };\n      }\n    })\n    .filter(Boolean);\n\n  return state;\n});\n// Check if relationship exist\neach(\n  $.relationshipsMapping,\n  get(\"tracker/relationships\", {\n    trackedEntity: $.data.from.trackedEntityInstance.trackedEntityInstance,\n  }).then((state) => {\n    const relationship = state.references.at(-1);\n    const toTei = relationship.to.trackedEntityInstance.trackedEntityInstance;\n    const hasRelationship = state.data.instances.find(\n      (r) => r.to.trackedEntity.trackedEntity === toTei\n    );\n    state.relationshipsToCreate ??= [];\n    if (!hasRelationship) {\n      state.relationshipsToCreate.push(relationship);\n    }\n    return state;\n  })\n);\n\n// Creating relationship between parent and child tei\neach($.relationshipsToCreate || [], create(\"relationships\", $.data));\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Upsert-Child-TEIs": {
          "id": "ba3e1803-acd8-4fe0-849f-6e0f4d120afd",
          "name": "Upsert Child TEIs",
          "body": "create(\n  \"tracker\",\n  {\n    trackedEntities: (state) => {\n      const childTeis = Object.values(state.childTeis).map(\n        ({ relationshipType, ...tei }) => tei\n      );\n      return childTeis;\n    },\n  },\n  {\n    params: {\n      atomicMode: \"ALL\",\n      async: false,\n    },\n  }\n);\n\nfn((state) => {\n  state.upsertedTeis =\n    state.data.bundleReport.typeReportMap.TRACKED_ENTITY.objectReports.map(\n      (report) => report.uid\n    );\n  return state;\n});\n\neach(\n  $.upsertedTeis,\n  get(`tracker/trackedEntities/${$.data}`, {\n    fields: \"*\",\n  }).then((state) => {\n    const {\n      trackedEntity,\n      programOwners,\n      enrollments,\n      attributes,\n      events,\n      orgUnit,\n    } = state.data || {};\n\n    const program = programOwners.find(\n      (po) => po.trackedEntity === trackedEntity && po.orgUnit === orgUnit\n    )?.program;\n\n    const patientUuid = attributes.find(\n      (a) => a.attribute === \"AYbfTPYMNJH\"\n    ).value;\n\n    const relationshipType = Object.values(state.formMaps).find(\n      (form) =>\n        form.programId === program &&\n        form.orgUnit === orgUnit &&\n        form.formName !== \"F00-Registration\"\n    )?.relationshipId;\n    state.childTeis ??= {};\n    state.childTeis[`${orgUnit}-${program}-${patientUuid}`] = {\n      relationshipType,\n      trackedEntity,\n      events: enrollments?.[0]?.events ?? events,\n      enrollment: enrollments?.[0]?.enrollment,\n      attributes,\n      orgUnit,\n      program,\n    };\n\n    return state;\n  })\n);\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        }
      },
      "edges": {
        "cron->Get-Patients": {
          "enabled": true,
          "id": "e5a1e40b-a435-495b-8260-3ddf4e4b6f95",
          "target_job_id": "9cc0cbea-ba1a-4555-83a1-a191944f303e",
          "source_trigger_id": "d10691b1-666f-4e0f-8064-40d4ce8fdc32",
          "condition_type": "always"
        },
        "Mappings->Upsert-TEIs": {
          "enabled": true,
          "id": "5953cda9-d8c3-454a-8a05-aac6c9c07eb5",
          "target_job_id": "5f47a65c-b739-46d7-8fa3-8a722458d4a3",
          "source_job_id": "0a6f5426-9c6d-4214-8e05-55cb9e368e14",
          "condition_type": "js_expression",
          "condition_label": "has-patients",
          "condition_expression": "state.patients.length > 0 && !state.errors\n"
        },
        "Upsert-TEIs->Get-Encounters": {
          "enabled": true,
          "id": "26954f83-daed-4f98-8011-c2c5bc24ecd3",
          "target_job_id": "ea92d31b-95a2-4683-85d5-f591513dbccc",
          "source_job_id": "5f47a65c-b739-46d7-8fa3-8a722458d4a3",
          "condition_type": "js_expression",
          "condition_label": "has-patient-uuids",
          "condition_expression": "state.patientUuids.length > 0 && !state.errors\n"
        },
        "Mappings->Get-Encounters": {
          "enabled": true,
          "id": "0fd2390e-6faf-4da6-8d4a-220685fe22ae",
          "target_job_id": "ea92d31b-95a2-4683-85d5-f591513dbccc",
          "source_job_id": "0a6f5426-9c6d-4214-8e05-55cb9e368e14",
          "condition_type": "js_expression",
          "condition_label": "has-no-patients",
          "condition_expression": "!state.errors && state.patients.length === 0\n"
        },
        "Create-Events->Update-TEIs": {
          "enabled": true,
          "id": "30bc10fc-d40f-4704-81f4-a05fefc5e1e3",
          "target_job_id": "3d50b0ba-7959-4a1b-8468-99ffd140a2ba",
          "source_job_id": "bc9ae464-bc1c-42ef-8d8d-24614ce5e4f1",
          "condition_type": "js_expression",
          "condition_label": "has-gender-updated",
          "condition_expression": "state?.teisToUpdate?.length > 0\n"
        },
        "Get-Encounters->Get-Parent-and-Child-TEIs": {
          "enabled": true,
          "id": "44fda748-0643-46bb-8e89-4b75bec4bdbd",
          "target_job_id": "29e87d9d-53c4-47bf-885d-19a70b839120",
          "source_job_id": "ea92d31b-95a2-4683-85d5-f591513dbccc",
          "condition_type": "js_expression",
          "condition_label": "has-encounters",
          "condition_expression": "!state.errors && state.encounters.length > 0\n"
        },
        "Get-Patients->Mappings": {
          "enabled": true,
          "id": "704bb712-f0be-4199-83b8-c84a3da5feb5",
          "target_job_id": "0a6f5426-9c6d-4214-8e05-55cb9e368e14",
          "source_job_id": "9cc0cbea-ba1a-4555-83a1-a191944f303e",
          "condition_type": "on_job_success"
        },
        "Event-Mappings->Create-Events": {
          "enabled": true,
          "id": "a314d87c-3497-4036-831a-3227d85b8c6b",
          "target_job_id": "bc9ae464-bc1c-42ef-8d8d-24614ce5e4f1",
          "source_job_id": "c31699da-9417-464f-84de-b3295a49720b",
          "condition_type": "js_expression",
          "condition_label": "has-events",
          "condition_expression": "state?.eventsMapping?.length > 0 && !state.errors\n"
        },
        "Get-Parent-and-Child-TEIs->Upsert-Child-TEIs": {
          "enabled": true,
          "id": "a07cd9c9-a88e-4854-8186-23a9f98a8103",
          "target_job_id": "ba3e1803-acd8-4fe0-849f-6e0f4d120afd",
          "source_job_id": "29e87d9d-53c4-47bf-885d-19a70b839120",
          "condition_type": "js_expression",
          "condition_label": "has-child-parent-teis",
          "condition_expression": "Object.keys(state?.childTeis)?.length > 0 && Object.keys(state?.parentTeis)?.length > 0\n"
        },
        "Upsert-Child-TEIs->Create-TEIs-Relationship": {
          "enabled": true,
          "id": "b5de09be-bff1-45fb-8726-ad8e8e02c2ca",
          "target_job_id": "ff3980d5-2f46-41f0-8d63-ccb63328325d",
          "source_job_id": "ba3e1803-acd8-4fe0-849f-6e0f4d120afd",
          "condition_type": "on_job_success"
        },
        "Create-TEIs-Relationship->Event-Mappings": {
          "enabled": true,
          "id": "d11da1ea-7d5d-4021-8ecb-9394be06623d",
          "target_job_id": "c31699da-9417-464f-84de-b3295a49720b",
          "source_job_id": "ff3980d5-2f46-41f0-8d63-ccb63328325d",
          "condition_type": "js_expression",
          "condition_label": "has-child-teis",
          "condition_expression": "state.childTeis && !state.errors\n"
        }
      }
    },
    "wf1-dhis2-omrs-migration": {
      "id": "37e14ed6-2caa-4ee2-8d8a-84bcbbd901e0",
      "name": "wf1-dhis2-omrs-migration",
      "inserted_at": "2025-12-11T13:57:23.820155Z",
      "lock_version": 45,
      "triggers": {
        "cron": {
          "enabled": false,
          "id": "836df7a7-d15f-4fc6-8f3d-5bb85c823218",
          "type": "cron",
          "cron_expression": "0 0 * * *"
        }
      },
      "jobs": {
        "Fetch-Metadata": {
          "id": "c4616bf4-6a28-4307-8798-d5710dcfc75f",
          "name": "Fetch Metadata",
          "body": "cursor($.manualCursor || $.lastRunDateTime).then((state) => {\n  console.log(\"Date cursor to filter TEI extract ::\", state.cursor);\n  return state;\n});\n\ncursor(\"now\", {\n  key: \"lastRunDateTime\",\n  format: (c) => {\n    const offset = 2; // GMT+2 (Geneva time)\n    c.setHours(c.getHours() + offset);\n    return c.toISOString().replace(\"Z\", \"\");\n  },\n}).then((state) => {\n  console.log(\"Next sync start date:\", state.lastRunDateTime);\n  return state;\n});\n\ncollections.get(\"mosul-metadata-mappings-staging\").then((state) => {\n  state.optsMap = state.data\n    .filter((i) => i.key.includes(\"optsMap-value-\"))\n    .map((i) => i.value);\n\n  state.identifiers = state.data\n    .filter((i) => i.key.includes(\"identifiers-value-\"))\n    .map((i) => i.value);\n\n  state.fileDateModified = state.data.filter(\n    (i) => i.key === \"fileDateModified\"\n  )?.[0]?.value;\n\n  state.formMaps = state.data.find((i) => i.key === \"formMaps\")?.value;\n\n  delete state.data;\n  delete state.references;\n  return state;\n});\n\nfn(({ identifiers, optsMap, formMaps, ...state }) => {\n  state.genderOptions = {\n    male: \"M\",\n    female: \"F\",\n    unknown: \"U\",\n    transgender_female: \"O\",\n    transgender_male: \"O\",\n    prefer_not_to_answer: \"O\",\n    gender_variant_non_conforming: \"O\",\n  };\n  // state.orgUnit = identifiers.find((i) => i.type === \"ORG_UNIT\")?.[\n  //   \"dhis2 attribute id\"\n  // ];\n  // state.program = identifiers.find((i) => i.type === \"PROGRAM\")?.[\n  //   \"dhis2 attribute id\"\n  // ];\n  state.orgUnit = \"sUpt0j2GmBD\"\n\n  state.program = \"dWdzxMuKa8Z\"\n  state.nationalityMap = optsMap\n    .filter((o) => o[\"DHIS2 DE full name\"] === \"Nationality\")\n    .reduce((acc, value) => {\n      acc[value[\"DHIS2 Option Code\"]] = value[\"value.uuid - External ID\"];\n      return acc;\n    }, {});\n\n  state.statusMap = optsMap\n    .filter((o) => {\n      const fullName = o[\"DHIS2 DE full name\"];\n      return fullName && fullName.includes(\" status\");\n    })\n    .reduce((acc, value) => {\n      acc[value[\"DHIS2 Option Code\"]] = value[\"value.uuid - External ID\"];\n      return acc;\n    }, {});\n\n  state.patientAttributes = Object.entries(formMaps.patient.dataValueMap)\n  .filter(([key]) => key !== \"qptKDiv9uPl\")\n  .reduce((acc, [key, value]) => {\n    acc[key] = value;\n    return acc;\n  }, {});\n  state.dhis2PatientNumber = identifiers.find(\n    (i) => i.type === \"DHIS2_PATIENT_NUMBER\"\n  )?.[\"omrs identifierType\"]; //DHIS2 ID or DHIS2 Patient Number\n\n  state.dhis2PatientNumberAttributeId = identifiers.find(\n    (i) => i.type === \"DHIS2_PATIENT_NUMBER\"\n  )?.[\"dhis2 attribute id\"]; //DHIS2 ID or DHIS2 Patient Number\n\n  state.openmrsAutoId = identifiers.find((i) => i.type === \"OPENMRS_AUTO_ID\")?.[\n    \"omrs identifierType\"\n  ]; //MSF ID or OpenMRS Patient Number\n\n  state.openmrsAutoIdAttributeId = identifiers.find(\n    (i) => i.type === \"OPENMRS_AUTO_ID\"\n  )?.[\"dhis2 attribute id\"]; //MSF ID or OpenMRS Patient Number\n\n  return state;\n});\n",
          "adaptor": "@openfn/language-common@2.1.1",
          "project_credential_id": null
        },
        "Get-Teis-and-Locations": {
          "id": "1845ba39-b556-452f-80db-c794c8b2bb9c",
          "name": "Get Teis and Locations",
          "body": "const findDuplicatePatient = teis => {\n  const seen = new Map();\n  const duplicates = new Set();\n\n  teis.forEach(tei => {\n    const patientNumber = tei.attributes.find(\n      attr => attr.code === 'patient_number'\n    )?.value;\n\n    if (seen.get(patientNumber)) {\n      duplicates.add(patientNumber);\n    } else {\n      seen.set(patientNumber, tei);\n    }\n  });\n\n  return duplicates;\n};\n// Get teis that are \"active\" in the target program\nget('tracker/trackedEntities', {\n  orgUnit: $.orgUnit,\n  program: $.program,\n  programStatus: 'ACTIVE',\n  updatedAfter: $.cursor,\n  skipPaging: true,\n});\n\nfn(state => {\n  console.log('# of TEIs found before filter ::', state.data.instances.length);\n  const uniqueTeis = [];\n  const duplicatePatients = [];\n  const missingPatientNumber = [];\n  const teisWithOMRSID = [];\n\n  const filteredTeis = state.data.instances.filter(\n    tei => tei.updatedAt >= state.cursor\n  );\n\n  console.log('Filtered TEIs ::', filteredTeis.length);\n  const duplicateIds = findDuplicatePatient(filteredTeis);\n\n  filteredTeis.forEach(tei => {\n    const patientNumber = tei.attributes.find(\n      attr => attr.code === 'patient_number'\n    )?.value;\n    const patientUid = tei.attributes.find(\n      attr => attr.code === 'patient_uid' || attr.displayName === 'OpenMRS patient UID'\n    )?.value;\n\n    if (patientUid) {\n      console.log(\n        `Skipping TEI:: ${tei.trackedEntity}. Found existing patient uid.`\n      );\n      teisWithOMRSID.push(tei)\n    }\n\n    if (!patientNumber) {\n      missingPatientNumber.push(tei);\n    } else if (duplicateIds.has(patientNumber)) {\n      duplicatePatients.push(tei);\n    } else {\n      uniqueTeis.push(tei);\n    }\n  });\n\n  console.log('# of Unique TEIs to migrate to OMRS ::', uniqueTeis.length);\n  console.log('# Duplicate Patients found::', duplicatePatients.length);\n\n  // return { uniqueTeis, duplicatePatients, filteredTeis, missingPatientNumber };\n  return {\n    ...state,\n    data: {},\n    references: [],\n    uniqueTeis,\n    teisWithOMRSID,\n    duplicatePatients,\n    missingPatientNumber,\n  };\n});\n\nget('optionGroups/kdef7pUey9f', {\n  fields: 'id,displayName,options[id,displayName,code]',\n});\n\nfn(({ data, ...state }) => {\n  state.locations = data;\n  return state;\n});\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Create-Patients": {
          "id": "d26ee140-a7d7-424b-8d82-ed34d25174f2",
          "name": "Create Patients",
          "body": "//Define gender options and prepare newPatientUuid and identifiers\nfn(state => {\n  const { uniqueTeis } = state;\n  if (uniqueTeis.length > 0)\n    console.log('# of TEIs to send to OpenMRS: ', uniqueTeis.length);\n  if (uniqueTeis.length === 0)\n    console.log('No data fetched in step prior to sync.');\n\n  return state;\n});\n\n//First we generate a unique OpenMRS ID for each patient\neach(\n  $.uniqueTeis,\n  post(\n    'idgen/identifiersource/8549f706-7e85-4c1d-9424-217d50a2988b/identifier'\n  ).then(state => {\n    state.identifiers ??= [];\n    state.identifiers.push(state.data.identifier);\n    return state;\n  })\n);\n\n// Then we map uniqueTeis to openMRS data model\nfn(state => {\n  const {\n    uniqueTeis,\n    nationalityMap,\n    genderOptions,\n    identifiers,\n    statusMap,\n    locations,\n  } = state;\n\n  const getValueForCode = (attributes, code) => {\n    const result = attributes.find(attribute => attribute.code === code);\n    return result ? result.value : undefined;\n  };\n\n  const calculateDOB = age => {\n    if (!age) return age;\n    const currentDate = new Date();\n    const currentYear = currentDate.getFullYear();\n    const birthYear = currentYear - age;\n\n    const birthday = new Date(\n      birthYear,\n      currentDate.getMonth(),\n      currentDate.getDay()\n    );\n\n    return birthday.toISOString().replace(/\\.\\d+Z$/, '+0000');\n  };\n\n  state.patients = uniqueTeis.map((d, i) => {\n    const patientNumber =\n      getValueForCode(d.attributes, 'patient_number') || d.trackedEntity; // Add random number for testing + Math.random()\n\n    const lonlat = d.attributes.find(a => a.attribute === 'rBtrjV1Mqkz')?.value;\n    const location = lonlat\n      ? locations.options.find(o => o.code === lonlat)?.displayName\n      : undefined;\n\n    let countyDistrict, cityVillage;\n\n    if (location) {\n      const match = location.match(/^(.*?)\\s*\\((.*?)\\)/);\n      if (match) {\n        [, countyDistrict, cityVillage] = match;\n        cityVillage = cityVillage.split('-')[0].trim(); // Remove country code and trim\n      }\n    }\n\n    // const attributes = d.attributes\n    //   .filter(a => a.attribute in state.patientAttributes)\n    //   .map(a => {\n    //     let value = a.value;\n\n    //     if (a.displayName === 'Nationality') {\n    //       value = nationalityMap[a.value];\n    //     } else if (a.displayName.includes(' status')) {\n    //       value = statusMap[a.value];\n    //     }\n\n    //     if (value) {\n    //       return {\n    //         attributeType: state.patientAttributes[a.attribute].trim(),\n    //         value,\n    //       };\n    //     }\n    //   })\n    //   .filter(Boolean);\n\n    return {\n      patientNumber,\n      person: {\n        age: getValueForCode(d.attributes, 'age'),\n        gender: genderOptions[getValueForCode(d.attributes, 'sex')] ?? 'U',\n        birthdate:\n          d.attributes.find(a => a.attribute === 'WDp4nVor9Z7')?.value ??\n          calculateDOB(getValueForCode(d.attributes, 'age')),\n        // d.attributes.find(a => a.attribute === 'WDp4nVor9Z7')?.value ?\n        // calculateDOB(getValueForCode(d.attributes, 'age')) : '1900-01-01',\n        birthdateEstimated: d.attributes.find(\n          a => a.attribute === 'WDp4nVor9Z7'\n        )\n          ? true\n          : false,\n        names: [\n          {\n            familyName:\n              d.attributes.find(a => a.attribute === 'fa7uwpCKIwa')?.value ??\n              'unknown',\n            givenName:\n              d.attributes.find(a => a.attribute === 'Jt9BhFZkvP2')?.value ??\n              'unknown',\n          },\n        ],\n        addresses: [\n          {\n            country: 'Iraq',\n            stateProvince: 'Ninewa',\n            countyDistrict,\n            cityVillage,\n          },\n        ],\n        // attributes,\n      },\n      identifiers: [\n        {\n          identifier: identifiers[i], //OMRS-generated identifier - see above\n          identifierType: '05a29f94-c0ed-11e2-94be-8c13b969e334',\n          location: 'cf6fa7d4-1f19-4c85-ac50-ff824805c51c', //default location old:44c3efb0-2583-4c80-a79e-1f756a03c0a1\n          preferred: true,\n        },\n        {\n          // uuid: d.trackedEntity,\n          identifier: patientNumber, //Patient Number from DHIS2\n          identifierType: '8d79403a-c2cc-11de-8d13-0010c6dffd0f', //Old Identification number\n          location: 'cf6fa7d4-1f19-4c85-ac50-ff824805c51c', //default location\n          preferred: false, //default value for this identifiertype\n        },\n      ],\n    };\n  });\n\n  return state;\n});\n\n// Creating patients in openMRS\neach(\n  $.patients,\n  upsert(\n    'patient',\n    {\n      q: $.data.patientNumber,\n      limit: 1,\n      startIndex: 0\n    },\n    state => {\n      const { patientNumber, ...patient } = state.data;\n      console.log(\n        'Upserting patient record...',\n        JSON.stringify(patient, null, 2)\n      );\n      return patient;\n    },\n    state => {\n      state.newPatientUuid ??= [];\n      //console.log('state.references ::', state.references)\n      state.newPatientUuid.push({\n        patient_number: state.references.at(-1)?.patientNumber,\n        omrs_patient_number: state.references\n          .at(-1)\n          ?.identifiers.find(\n            i => (i.identifierType === `${state.openmrsAutoId}`)\n          ),\n        uuid: state.data.uuid,\n      });\n      return state;\n    }\n  )\n);\n\n// Clean up state\nfn(({ data, references, ...state }) => state);\n",
          "adaptor": "@openfn/language-openmrs@4.2.0",
          "project_credential_id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08"
        },
        "Update-Teis": {
          "id": "f4702169-b017-43da-8e66-5ee3bfa305fb",
          "name": "Update Teis",
          "body": "fn(state => {\n  if (state.newPatientUuid.length === 0) {\n    console.log('No data fetched in step prior to sync.');\n  }\n\n  console.log(\n    'newPatientUuid ::',\n    JSON.stringify(state.newPatientUuid, null, 2)\n  );\n  return state;\n});\n\n// Update TEI on DHIS2\neach(\n  $.newPatientUuid,\n  upsert(\n    'trackedEntityInstances',\n    {\n      ou: $.orgUnit,\n      program: $.program,\n      filter: [`${$.dhis2PatientNumberAttributeId}:Eq:${$.data.patient_number}`],\n    },\n    state => {\n      const payload = {\n        orgUnit: state.orgUnit,\n        program: state.program,\n        trackedEntityType: 'cHlzCA2MuEF',\n        attributes: [\n          {\n            attribute: `${state.dhis2PatientNumberAttributeId}`,\n            value: `${state.data.patient_number}`,\n          }, //DHIS2 patient number to use as lookup key\n          { attribute: 'AYbfTPYMNJH', value: `${state.data.uuid}` }, //OMRS patient uuid\n          {\n            attribute: `${state.openmrsAutoIdAttributeId}`,\n            value: `${state.data.omrs_patient_number.identifier}`,\n          }, //id generated in wf1-2 e.g., \"IQ146-24-000-027\"\n        ],\n      }\n\n      console.log('final payload to send to dhis2:', payload)\n      return payload;\n    }\n  )\n  // {\n  //   orgUnit: $.orgUnit,\n  //   program: $.program,\n  //   trackedEntityType: 'cHlzCA2MuEF',\n  //   attributes: [\n  //     {\n  //       attribute: `${$.dhis2PatientNumberAttributeId}`,\n  //       value: `${state.data.patient_number}`,\n  //     }, //DHIS2 patient number to use as lookup key\n  //     { attribute: 'AYbfTPYMNJH', value: `${state.data.uuid}` }, //OMRS patient uuid\n  //     {\n  //       attribute: `${state.openmrsAutoIdAttributeId}`,\n  //       value: `${state.data.omrs_patient_number.identifier}`,\n  //     }, //id generated in wf1-2 e.g., \"IQ146-24-000-027\"\n  //   ],\n  // },\n);\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Alert-Admin-of-Duplicate-TEIs": {
          "id": "eaa87fc7-1b9c-4c23-85ef-894fed073145",
          "name": "Alert Admin of Duplicate TEIs",
          "body": "fn(state => {\n  const code = 'DUPLICATE_PATIENT_NUMBERS';\n  const description = `Found ${state.duplicatePatients.length} TIEs with duplicate patient numbers`;\n  const message = `${code}: ${description}`;\n  const patientNumbers = state.duplicatePatients.map(\n    patient =>\n      patient.attributes.find(attr => attr.code === 'patient_number').value\n  );\n\n  const details = {\n    code,\n    description,\n    duplicatePatientNumbers: patientNumbers,\n  };\n  const e = new Error(message);\n  e.details = details;\n  console.error(e.details);\n  throw e;\n});\n",
          "adaptor": "@openfn/language-common@2.1.1",
          "project_credential_id": null
        },
        "Validate-TEIs-with-OMRS-Id": {
          "id": "97edd4ca-1cef-48af-827d-fd8d2450c4fe",
          "name": "Validate TEIs with OMRS Id",
          "body": "fn((state) => {\n  state.patientUuids = state.teisWithOMRSID.map((patient) => {\n    return patient.attributes.find(\n      (attr) => attr.displayName === \"OpenMRS patient UID\"\n    )?.value;\n  });\n  state.notFound ??= [];\n  return state;\n});\n\neach(\n  $.patientUuids,\n  get(`patient/${$.data}`).catch((error, state) => {\n    if (error) {\n      const tei = state.teisWithOMRSID.find(\n        (tei) =>\n          tei.attributes.find(\n            (attr) => attr.displayName === \"OpenMRS patient UID\"\n          )?.value === state.data\n      );\n      state.notFound.push({ patient: state.data, tei: tei.trackedEntity });\n    }\n    return state;\n  })\n);\n\nfnIf($.notFound.length > 0, (state) => {\n  const details = state.notFound\n    .map(\n      ({ patient, tei }) =>\n        `Patient not found in OMRS for TEI:${tei} with OMRS ID: ${patient}.`\n    )\n    .join(\"\\n\");\n  const e = new Error(details);\n  throw e;\n});\n",
          "adaptor": "@openfn/language-openmrs@4.2.0",
          "project_credential_id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08"
        }
      },
      "edges": {
        "cron->Fetch-Metadata": {
          "enabled": true,
          "id": "4f025e3a-80af-47ff-8c25-8891eff0c486",
          "target_job_id": "c4616bf4-6a28-4307-8798-d5710dcfc75f",
          "source_trigger_id": "836df7a7-d15f-4fc6-8f3d-5bb85c823218",
          "condition_type": "always"
        },
        "Fetch-Metadata->Get-Teis-and-Locations": {
          "enabled": true,
          "id": "947f7f92-1205-4fda-8595-4d8025786c35",
          "target_job_id": "1845ba39-b556-452f-80db-c794c8b2bb9c",
          "source_job_id": "c4616bf4-6a28-4307-8798-d5710dcfc75f",
          "condition_type": "on_job_success"
        },
        "Get-Teis-and-Locations->Create-Patients": {
          "enabled": true,
          "id": "b4e06a4a-f873-407f-824a-39ad2006ccb9",
          "target_job_id": "d26ee140-a7d7-424b-8d82-ed34d25174f2",
          "source_job_id": "1845ba39-b556-452f-80db-c794c8b2bb9c",
          "condition_type": "js_expression",
          "condition_label": "has-teis",
          "condition_expression": "state.uniqueTeis.length > 0 && !state.errors\n"
        },
        "Create-Patients->Update-Teis": {
          "enabled": true,
          "id": "05d88b14-52e6-4f24-8acc-ed0ba455c942",
          "target_job_id": "f4702169-b017-43da-8e66-5ee3bfa305fb",
          "source_job_id": "d26ee140-a7d7-424b-8d82-ed34d25174f2",
          "condition_type": "on_job_success"
        },
        "Get-Teis-and-Locations->Alert-Admin-of-Duplicate-TEIs": {
          "enabled": true,
          "id": "c0260aec-64c9-4f5b-8327-bca677cfdcba",
          "target_job_id": "eaa87fc7-1b9c-4c23-85ef-894fed073145",
          "source_job_id": "1845ba39-b556-452f-80db-c794c8b2bb9c",
          "condition_type": "js_expression",
          "condition_label": "has-duplicate-patients",
          "condition_expression": "state.duplicatePatients.length > 0 && !state.errors\n"
        },
        "Get-Teis-and-Locations->Validate-TEIs-with-OMRS-Id": {
          "enabled": true,
          "id": "3c86df64-2a6a-42d0-8107-affe53db8190",
          "target_job_id": "97edd4ca-1cef-48af-827d-fd8d2450c4fe",
          "source_job_id": "1845ba39-b556-452f-80db-c794c8b2bb9c",
          "condition_type": "js_expression",
          "condition_label": "has-teisWithOMRSID",
          "condition_expression": "!state.errors && state. teisWithOMRSID.length > 0\n"
        }
      }
    },
    "wf3-omrs-dhis2": {
      "id": "fb49b01d-dba8-420a-9f4c-b9ca20984ee5",
      "name": "wf3-omrs-dhis2",
      "inserted_at": "2025-12-11T13:58:24.180064Z",
      "lock_version": 54,
      "triggers": {
        "cron": {
          "enabled": false,
          "id": "cd9ea573-fb86-4ec4-8c39-200c7de22dfb",
          "type": "cron",
          "cron_expression": "0 0 * * *"
        }
      },
      "jobs": {
        "Get-Mappings-from-Collection": {
          "id": "0acf6701-064d-412d-8672-db507c9e95c6",
          "name": "Get Mappings from Collection",
          "body": "const isValidUUID = (id) => {\n  if (!id || typeof id !== \"string\") return false;\n\n  const UUID_PATTERN =\n    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n  return UUID_PATTERN.test(id);\n};\n\ncollections.get(\"mosul-metadata-mappings-staging\").then((state) => {\n  state.optsMap = state.data\n    .filter((i) => i.key.includes(\"optsMap-value-\"))\n    .map((i) => i.value);\n\n  state.identifiers = state.data\n    .filter((i) => i.key.includes(\"identifiers-value-\"))\n    .map((i) => i.value);\n  state.syncedAt = state.data.find((i) => i.key === \"syncedAt\")?.value;\n  state.formMetadata = state.data.find((i) => i.key === \"formMetadata\")?.value;\n  state.placeOflivingMap = state.data.find(\n    (i) => i.key === \"placeOflivingMap\"\n  )?.value;\n  state.sourceFile = state.data.filter(\n    (i) => i.key === \"sourceFile\"\n  )?.[0]?.value;\n  state.fileDateModified = state.data.filter(\n    (i) => i.key === \"fileDateModified\"\n  )?.[0]?.value;\n  state.formMaps = state.data.find((i) => i.key === \"formMaps\")?.value;\n\n  // TODO: Remove state.optionSetKey, when needed\n  // Build from state.formMaps\n  state.optionSetKey = state.data.filter(\n    (i) => i.key === \"optionSetKey\"\n  )?.[0]?.value;\n\n  delete state.data;\n  delete state.references;\n  return state;\n});\n\nfn((state) => {\n  const { formMetadata, identifiers, ...rest } = state;\n\n  rest.v2FormUuids = formMetadata\n    .filter(\n      (form) =>\n        isValidUUID(form[\"OMRS form.uuid\"]) &&\n        form[\"OMRS Form Version\"] === \"v4-2025\"\n    )\n    .map((form) => form[\"OMRS form.uuid\"]);\n  rest.formUuids = formMetadata\n    .filter(\n      (form) =>\n        isValidUUID(form[\"OMRS form.uuid\"]) && form[\"Workflow\"] === \"WF3\"\n    )\n    .map((form) => form[\"OMRS form.uuid\"]);\n\n  // rest.orgUnit = identifiers.find(i => i.type === 'ORG_UNIT')?.[\n  //   'dhis2 attribute id'\n  // ];\n\n  rest.orgUnit = \"sUpt0j2GmBD\";\n\n  rest.program = \"dWdzxMuKa8Z\";\n\n  rest.patientProgramStage = state.formMaps.patient.programStage;\n\n  rest.dhis2PatientNumber = identifiers.find(\n    (i) => i.type === \"DHIS2_PATIENT_NUMBER\"\n  )?.[\"omrs identifierType\"]; //DHIS2 ID or DHIS2 Patient Number\n\n  rest.openmrsAutoId = identifiers.find((i) => i.type === \"OPENMRS_AUTO_ID\")?.[\n    \"omrs identifierType\"\n  ]; //MSF ID or OpenMRS Patient Number\n\n  return rest;\n});\n",
          "adaptor": "@openfn/language-common@2.3.0",
          "project_credential_id": "90cddfa1-9b77-4625-a812-2a04d061522c"
        },
        "Get-Encounters": {
          "id": "2b1e02ae-7546-480a-86cc-77a815f61256",
          "name": "Get Encounters",
          "body": "function removeLinks(data) {\n  if (Array.isArray(data)) {\n    return data.map(removeLinks);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const { links, ...rest } = data;\n    return Object.fromEntries(\n      Object.entries(rest).map(([key, value]) => [key, removeLinks(value)])\n    );\n  }\n\n  return data;\n}\n\nfunction removeNulls(data) {\n  if (Array.isArray(data)) {\n    return data.filter((item) => item !== null).map(removeNulls);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const result = {};\n    for (const [key, value] of Object.entries(data)) {\n      if (value !== null) {\n        result[key] = removeNulls(value);\n      }\n    }\n    return result;\n  }\n\n  return data;\n}\nconst delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n// Fetch patient encounters\neach(\n  $.patientUuids,\n  get(\"encounter\", { patient: $.data, v: \"full\" }).then((state) => {\n    const patientUuid = state.references.at(-1);\n\n    const filteredEncounters = state?.data?.results\n      .filter(\n        (e) =>\n          e.auditInfo.dateCreated >= state.cursor &&\n          state.formUuids.includes(e?.form?.uuid)\n      )\n      .sort(\n        (a, b) =>\n          new Date(b.auditInfo.dateCreated) - new Date(a.auditInfo.dateCreated)\n      );\n\n    // Why we only keep the latest one form encounter?\n    // const encounters = filteredEncounters.map((e) => e[0]).filter((e) => e);\n    state.encounters ??= [];\n    state.encounters.push(...filteredEncounters);\n\n    console.log(\n      state.encounters?.length,\n      `# of filtered encounters found in OMRS for ${patientUuid}`\n    );\n    delay(1500);\n\n    return state;\n  })\n);\n\nfn((state) => {\n  const {\n    data,\n    index,\n    response,\n    references,\n    allResponse,\n    patientUuids,\n    patients,\n    encounters,\n    ...next\n  } = state;\n\n  if (encounters?.length) {\n    const encountersByVisit = encounters\n      .map((encounter) => {\n        const { uuid, patient, obs, form, encounterDatetime, visit } =\n          removeLinks(removeNulls(encounter));\n\n        return {\n          visit: { uuid: visit.uuid },\n          uuid,\n          patient: {\n            uuid: patient.uuid,\n            display: patient.display,\n          },\n          obs: obs?.map((o) => {\n            return {\n              uuid: o.uuid,\n              concept: o.concept,\n              display: o.display,\n              formFieldPath: o.formFieldPath,\n              value: o.value,\n            };\n          }),\n          form: {\n            uuid: form?.uuid,\n            display: form?.display,\n            description: form?.description,\n            name: form?.name,\n          },\n          encounterDatetime,\n        };\n      })\n      .reduce((acc, curr) => {\n        const visitPerForm = `${curr.visit.uuid}-${curr.form.uuid}`;\n        if (!acc[visitPerForm]) {\n          acc[visitPerForm] = [curr];\n        } else {\n          acc[visitPerForm].push(curr);\n        }\n\n        return acc;\n      }, {});\n\n    next.latestEncountersByVisit = Object.values(encountersByVisit)\n      .map((encounters) => encounters[0]) // Latest encounter per visit\n      .flat();\n\n    next.encountersPatientUuids = [\n      ...new Set(\n        next.latestEncountersByVisit.map((encounter) => encounter.patient.uuid)\n      ),\n    ];\n  } else {\n    console.log(\"No encounters found for cursor: \", next.cursor);\n  }\n\n  return next;\n});\n",
          "adaptor": "@openfn/language-openmrs@4.3.0",
          "project_credential_id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08"
        },
        "Create-Events": {
          "id": "2d668d2e-c513-4b58-88bb-8a2d3261d9a2",
          "name": "Create Events",
          "body": "// Create or update events for each encounter create(\ncreate(\n  \"tracker\",\n  {\n    events: (state) => {\n      console.log(\n        \"Creating events for: \",\n        JSON.stringify(state.eventsMapping, null, 2)\n      );\n      return state.eventsMapping;\n    },\n  },\n  {\n    params: {\n      async: false,\n      dataElementIdScheme: \"UID\",\n      importStrategy: \"CREATE_AND_UPDATE\",\n    },\n  }\n);\n\nfn(({ lastRunDateTime }) => ({ lastRunDateTime }));\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Custom-Logic-for-Events": {
          "id": "782cdfc3-9357-4763-8681-798ae1b29fd1",
          "name": "Custom Logic for Events",
          "body": "const formIdByName = (name, formMaps) => {\n  const entry = Object.entries(formMaps).find(([formId, form]) =>\n    form.formName.includes(name)\n  );\n  return entry ? entry[0] : null;\n};\nconst MILLISECONDS_PER_YEAR = 365.25 * 24 * 60 * 60 * 1000;\nconst calculateAge = (dob) =>\n  Math.floor((new Date() - new Date(dob)) / MILLISECONDS_PER_YEAR);\n\nconst teiAge = (tei) => {\n  let age = tei?.attributes?.find(\n    (attr) => attr.attribute === \"T1iX2NuPyqS\"\n  )?.value;\n\n  if (!age) {\n    const birthdate = tei?.attributes?.find(\n      (attr) => attr.attribute === \"WDp4nVor9Z7\"\n    )?.value;\n    age = calculateAge(birthdate);\n  }\n  return age;\n};\n\nconst ageInDays = (dob, encounterDate) => {\n  const birth = new Date(dob);\n  const encounter = new Date(encounterDate);\n  const diffTime = Math.abs(encounter - birth);\n  return Math.floor(diffTime / (1000 * 60 * 60 * 24));\n};\n\nfunction f8(encounter) {\n  const obsDatetime = findObsByConcept(\n    encounter,\n    \"7f00c65d-de60-467a-8964-fe80c7a85ef0\"\n  )?.value;\n\n  if (!obsDatetime) return [];\n  const datePart = obsDatetime.substring(0, 10);\n  const timePart = obsDatetime.substring(11, 19);\n  return [\n    {\n      dataElement: \"iQio7NYSA3m\",\n      value: timePart,\n    },\n    // {\n    //   dataElement: \"yprMS34o8s3\",\n    //   value: datePart,\n    // }, //This mapping might have been removed, to be confirmed.\n  ];\n}\n\nfunction f27(encounter) {\n  const admissionDate = findObsByConcept(\n    encounter,\n    \"7f00c65d-de60-467a-8964-fe80c7a85ef0\"\n  )?.value;\n  if (!admissionDate) return [];\n  const timePart = admissionDate.substring(11, 19);\n  const datePart = admissionDate.replace(\"+0000\", \"\");\n  return [\n    {\n      dataElement: \"eYvDzr2m8f5\",\n      value: timePart,\n    },\n    {\n      eventDate: datePart,\n    },\n  ];\n}\n\nfunction f23(encounter) {\n  // Define concept mappings object for cleaner reference\n  const CONCEPT_ID = \"f587c6a3-6a71-48ae-83b2-5e2417580b6f\";\n\n  const conditions = [\n    {\n      // 'Neonatal infection in previous pregnancy' is selected in OMRS\n      dataElement: \"H9noxo3e7ox\",\n      valueId: \"09d6bb71-b061-4cae-85f3-2ff020a10c92\",\n    },\n    {\n      // 'Mother got antibiotics during delivery/post-partum ' is selected in OMRS\n      dataElement: \"GfN1TtpqDoJ\",\n      valueId: \"3764bd79-9ae2-478a-88e7-51adc0a8a2e3\",\n    },\n    {\n      //'Infection in other baby if multiple pregnancy' is selected in OMRS\n      dataElement: \"WS1p4xgbZqU\",\n      valueId: \"95d55453-060b-43a2-b4a0-11848dd9ac72\",\n    },\n    {\n      //'Maternal fever during labour' is selected in OMRS\n      dataElement: \"WX19iDuB4Dj\",\n      valueId: \"890f4bdb-91bc-484c-a9cf-17f5068b0507\",\n    },\n    {\n      // 'Rupture of membranes 18h' is selected in OMRS\n      dataElement: \"eLKs6GUHJdS\",\n      valueId: \"28d10ce0-7f72-4654-834d-64fa37ad8e85\",\n    },\n    {\n      // 'Pre-labour rupture of membranes <18h' is selected in OMRS\n      dataElement: \"hCfngwimBjX\",\n      valueId: \"cf48d000-a741-44e0-81cb-a51f88595e41\",\n    },\n    {\n      // 'Smelling/cloudy amniotic fluid' is selected in OMRS\n      dataElement: \"qc7ubAwULxs\",\n      valueId: \"49829d18-22c9-404c-a79a-49ed6b21d2be\",\n    },\n  ];\n\n  // Map through conditions and create final mapping\n  return conditions.map((condition) => ({\n    dataElement: condition.dataElement,\n    value: findByConceptAndValue(encounter, CONCEPT_ID, condition.valueId)\n      ? true\n      : undefined,\n  }));\n}\nfunction f41(encounter) {\n  const obsDatetime = findObsByConcept(\n    encounter,\n    \"40108bf5-0bbd-42e8-8102-bcbd0550a943\"\n  )?.value;\n  if (!obsDatetime) return [];\n  // what is obsdatetime?\n  //TODO: extract time componenet and assign\n  //TODO: set date component to eventDate attribute\n  //TODO: use that when setting OccuredAt\n  //TODO: Apply the same changes for f27\n  const timePart = obsDatetime.substring(11, 19);\n  const datePart = obsDatetime.replace(\"+0000\", \"\");\n\n  return [\n    {\n      dataElement: \"gluXfK7zg1d\",\n      value: timePart,\n    },\n    {\n      dataElement: \"bkissws06TK\",\n      value: timePart,\n    },\n    {\n      eventDate: datePart,\n    },\n  ];\n}\n\nfunction f42(encounter) {\n  const obsDatetime = findObsByConcept(\n    encounter,\n    \"7f00c65d-de60-467a-8964-fe80c7a85ef0\"\n  )?.value;\n  if (!obsDatetime) return [];\n\n  return [\n    {\n      dataElement: \"xr2Dqw14DGX\",\n      value: obsDatetime,\n    },\n  ];\n}\n\nfunction f43(encounter, tei) {\n  const mappings = [];\n  const obsDatetime = findObsByConcept(\n    encounter,\n    \"88472a4e-f26e-4235-8144-4ad6df874949\"\n  )?.value;\n\n  const birthdate = tei?.attributes?.find(\n    (attr) => attr.attribute === \"WDp4nVor9Z7\"\n  )?.value;\n\n  const datePart = obsDatetime.substring(0, 10);\n  const timePart = obsDatetime.substring(11, 19);\n\n  if (obsDatetime) {\n    mappings.push(\n      {\n        dataElement: \"tR7XL9TPVkr\",\n        value: datePart,\n      },\n      {\n        dataElement: \"P8bmDESxYqn\",\n        value: timePart,\n      }\n    );\n  }\n\n  if (birthdate) {\n    mappings.push({\n      dataElement: \"Z2RzJFkXzII\",\n      value: ageInDays(birthdate, encounter.encounterDatetime),\n    });\n  }\n  return mappings;\n}\nfunction mapAttribute(attributes, attributeMap) {\n  const attrMapping = Object.entries(attributeMap)\n    .map(([dataElement, attributeId]) => {\n      const value = attributes?.find(\n        (attr) => attr.attribute === attributeId\n      )?.value;\n\n      return { dataElement, value };\n    })\n    .filter(Boolean);\n\n  return attrMapping;\n}\n\nconst findObsByConcept = (encounter, conceptUuid) => {\n  const [conceptId, questionId] = conceptUuid.split(\"-rfe-\");\n  const answer = encounter.obs.find(\n    (o) =>\n      o.concept.uuid === conceptId &&\n      (questionId ? o.formFieldPath === `rfe-${questionId}` : true)\n  );\n\n  return answer;\n};\n\nconst findByConceptAndValue = (encounter, conceptUuid, value) => {\n  const [conceptId, questionId] = conceptUuid.split(\"-rfe-\");\n  const answer = encounter.obs.find(\n    (o) =>\n      o.concept.uuid === conceptId &&\n      (questionId ? o.formFieldPath === `rfe-${questionId}` : true) &&\n      o.value.uuid === value\n  );\n  return answer;\n};\n\nconst findDataValue = (encounter, dataElement, metadataMap) => {\n  if (dataElement === \"H9noxo3e7ox\") {\n    return;\n  }\n  const { optsMap, optionSetKey, form } = metadataMap;\n  const [conceptUuid, questionId] =\n    form.dataValueMap[dataElement]?.split(\"-rfe-\");\n  const answer = encounter.obs.find((o) => o.concept.uuid === conceptUuid);\n  const isObjectAnswer = answer && typeof answer.value === \"object\";\n  const isStringAnswer = answer && typeof answer.value === \"string\";\n  const isNumberAnswer = answer && typeof answer.value === \"number\";\n\n  if (isStringAnswer || isNumberAnswer) {\n    return answer.value;\n  }\n\n  if (isObjectAnswer) {\n    const optionKey = questionId\n      ? `${encounter.form.uuid}-${answer.concept.uuid}-rfe-${questionId}`\n      : `${encounter.form.uuid}-${answer.concept.uuid}`;\n    const matchingOptionSet = optionSetKey[optionKey];\n\n    const opt = optsMap.find(\n      (o) =>\n        o[\"value.uuid - External ID\"] === answer.value.uuid &&\n        o[\"DHIS2 Option Set UID\"] === matchingOptionSet\n    );\n    const matchingOption =\n      opt?.[\"DHIS2 Option Code\"] ||\n      opt?.[\"DHIS2 Option name\"] || // TODO: Sync with AK: We have added this because  Opticon Code is empty in some cases.\n      answer?.value?.display; //TODO: revisit this logic if optionSet not found\n\n    // console.log({ matchingOptionSet, opt, matchingOption });\n    // If we get errors on true/false, yes/no mappings remove && !matchingOptionSet\n    if ([\"FALSE\", \"No\"].includes(matchingOption) && !matchingOptionSet)\n      return \"false\";\n    if ([\"TRUE\", \"Yes\"].includes(matchingOption) && !matchingOptionSet)\n      return \"true\";\n\n    return matchingOption;\n  }\n\n  const isEncounterDate =\n    conceptUuid === \"encounter-date\" &&\n    [\"CXS4qAJH2qD\", \"I7phgLmRWQq\", \"yUT7HyjWurN\", \"EOFi7nk2vNM\"].includes(\n      dataElement\n    );\n\n  // These are data elements for encounter date in DHIS2\n  // F29 MHPSS Baseline v2, F31-mhGAP Baseline v2, F30-MHPSS Follow-up v2, F32-mhGAp Follow-up v2\n  if (isEncounterDate) {\n    return encounter.encounterDatetime.replace(\"+0000\", \"\");\n  }\n\n  return \"\";\n};\n\nconst buildDataValues = (encounter, tei, mappingConfig) => {\n  const {\n    optsMap,\n    optionSetKey,\n    form,\n    f08Form,\n    f09Form,\n    f23Form,\n    f24Form,\n    f25Form,\n    f26Form,\n    f27Form,\n    f28Form,\n    f41Form,\n    f42Form,\n    f43Form,\n  } = mappingConfig;\n  let formMapping = [];\n  const visitUuid = encounter.visit.uuid;\n\n  if ([f08Form, f09Form].includes(encounter.form.uuid)) {\n    // F08 Form Encounter Mapping\n    const f8Mapping = f8(encounter);\n    formMapping.push(...f8Mapping);\n\n    // F09 Form Encounter Mapping\n    const attributeMap = {\n      Lg1LrNf9LQR: \"qptKDiv9uPl\",\n      OVo3FxLURtH: \"k26cdlS78i9\",\n      f3n6kIB9IbI: \"Rv8WM2mTuS5\",\n      oc9zlhOoWmP: \"YUIQIA2ClN6\",\n      DbyD9bbGIvE: \"Qq6xQ2s6LO8\",\n      fiPFww1viBB: \"rBtrjV1Mqkz\",\n      FsL5BjQocuo: \"Xvzc9e0JJmp\",\n      Pi1zytYdq6l: \"P4wdYGkldeG\",\n    };\n    const f09Mapping = mapAttribute(tei.attributes, attributeMap);\n    formMapping.push(...f09Mapping);\n  }\n\n  if ([f23Form, f24Form].includes(encounter.form.uuid)) {\n    // F23 Form Encounter Mapping\n    const f23Mapping = f23(encounter);\n    formMapping.push(...f23Mapping);\n\n    // F24 Form Encounter Mapping\n    const attributeMap = {\n      Hww0CNYYt3E: \"qptKDiv9uPl\",\n      // Z7vMFdnQxpE: \"WDp4nVor9Z7\",\n      // L97SmAK11DN: \"T1iX2NuPyqS\",\n      yE0dIWW0TXP: \"rBtrjV1Mqkz\",\n      fnH6H3biOkE: \"P4wdYGkldeG\",\n    };\n    const attributeMapping = mapAttribute(tei.attributes, attributeMap);\n\n    const dob = tei?.attributes?.find(\n      (attr) => attr.attribute === \"WDp4nVor9Z7\"\n    )?.value;\n\n    if (dob) {\n      let ageInDays = calculateAge(dob) * 365;\n      attributeMapping.push({\n        dataElement: \"Z7vMFdnQxpE\",\n        value: ageInDays,\n      });\n    }\n    if (!dob) {\n      const age = tei?.attributes?.find(\n        (attr) => attr.attribute === \"T1iX2NuPyqS\"\n      )?.value;\n\n      const ageInMonths = age * 12;\n\n      attributeMapping.push({\n        dataElement: \"L97SmAK11DN\",\n        value: ageInMonths,\n      });\n    }\n\n    formMapping.push(...attributeMapping);\n  }\n\n  if ([f25Form, f26Form].includes(encounter.form.uuid)) {\n    const attributeMap = {\n      eDuqRYx3wLx: \"qptKDiv9uPl\",\n      d7wOfzPBbQD: \"T1iX2NuPyqS\",\n      y9pK9sVcbU9: \"k26cdlS78i9\",\n      // b7z6xIpzkim: \"\",\n      CDuiRuOcfzj: \"YUIQIA2ClN6\",\n      JMhFzB97fcS: \"Qq6xQ2s6LO8\",\n      Nd43pz1Oo62: \"rBtrjV1Mqkz\",\n      kcSuQKfU5Zo: \"P4wdYGkldeG\",\n    };\n    const attributeMapping = mapAttribute(tei.attributes, attributeMap);\n\n    const dob = tei?.attributes?.find(\n      (attr) => attr.attribute === \"WDp4nVor9Z7\"\n    )?.value;\n\n    if (dob) {\n      let ageInDays = calculateAge(dob) * 365;\n      attributeMapping.push({\n        dataElement: \"b7z6xIpzkim\",\n        value: ageInDays,\n      });\n    }\n\n    formMapping.push(...attributeMapping);\n  }\n\n  if ([f27Form, f28Form].includes(encounter.form.uuid)) {\n    // F27 Form Encounter Mapping\n    const f27Mapping = f27(encounter);\n    formMapping.push(...f27Mapping);\n\n    // F28 Form Encounter Mapping\n    const attributeMap = {\n      WP5vr8KB2lH: \"qptKDiv9uPl\",\n      Y7qzoa4Qaiz: \"YUIQIA2ClN6\",\n      XCUd9xOGXkn: \"Qq6xQ2s6LO8\",\n      onKT21rxH6Z: \"rBtrjV1Mqkz\",\n      sCKCNreiqEA: \"Xvzc9e0JJmp\",\n      ci9C72RjN8Z: \"P4wdYGkldeG\",\n    };\n    const attributeMapping = mapAttribute(tei.attributes, attributeMap);\n\n    const f28Mapping = [\n      {\n        dataElement: \"NWOnMq8h4w1\",\n        value: teiAge(tei),\n      },\n    ];\n    formMapping.push(...attributeMapping, ...f28Mapping);\n  }\n\n  if ([f41Form, f42Form, f43Form].includes(encounter.form.uuid)) {\n    // F41 Form Encounter Mapping\n    const f41Mapping = f41(encounter);\n    formMapping.push(...f41Mapping);\n\n    // F42 Form Encounter Mapping\n    const f42Mapping = f42(encounter);\n    formMapping.push(...f42Mapping);\n\n    // F43 Form Encounter Mapping\n    const attributeMap = {\n      eMXqL66pJSV: \"qptKDiv9uPl\",\n      hT8pIot8b6Y: \"k26cdlS78i9\",\n      BA7aQjiwlrL: \"Rv8WM2mTuS5\",\n      KRNhyZHeGGM: \"YUIQIA2ClN6\",\n      fUxvDvbPKlU: \"Qq6xQ2s6LO8\",\n      xw5Vres1Ndt: \"rBtrjV1Mqkz\",\n      iGHeO9F8CKm: \"Xvzc9e0JJmp\",\n    };\n    const f43AttributeMapping = mapAttribute(tei.attributes, attributeMap);\n    formMapping.push(...f43AttributeMapping, ...f43(encounter, tei));\n  }\n\n  const dataValuesMapping = Object.keys(form.dataValueMap)\n    .map((dataElement) => {\n      const value = findDataValue(encounter, dataElement, {\n        optsMap,\n        optionSetKey,\n        form,\n      });\n\n      return { dataElement, value };\n    })\n    .filter((d) => d.value);\n\n  dataValuesMapping.push({\n    dataElement: \"rbFVBI2N6Ex\",\n    value: visitUuid,\n  });\n\n  //setting the visitUuid here as a data element\n  const combinedMapping = [...dataValuesMapping, ...formMapping].filter(\n    Boolean\n  );\n\n  return combinedMapping;\n};\n\nfn((state) => {\n  const f08Form = formIdByName(\"F08-ITFC Admission\", state.formMaps);\n  const f09Form = formIdByName(\"F09-ITFC Discharge\", state.formMaps);\n  const f23Form = formIdByName(\"F23-Neonatal Admission\", state.formMaps);\n  const f24Form = formIdByName(\"F24-Neonatal Discharge\", state.formMaps);\n  const f25Form = formIdByName(\"F25-Pediatrics Admission\", state.formMaps);\n  const f26Form = formIdByName(\"F26-Pediatrics Discharge\", state.formMaps);\n  const f27Form = formIdByName(\"F27-Adult Admission\", state.formMaps);\n  const f28Form = formIdByName(\"F28-Adult Discharge\", state.formMaps);\n  const f41Form = formIdByName(\"F41-ER Triage\", state.formMaps);\n  const f42Form = formIdByName(\"F42-ER Consultation\", state.formMaps);\n  const f43Form = formIdByName(\"F43-ER Exit\", state.formMaps);\n\n  const pairedEncounters = state.latestEncountersByVisit.reduce((acc, obj) => {\n    const program = state.formMaps[obj.form.uuid].programId;\n    const orgUnit = state.formMaps[obj.form.uuid].orgUnit;\n    const programStage = state.formMaps[obj.form.uuid].programStage;\n    const patientOuProgram = `${orgUnit}:${program}:${programStage}:${obj.patient.uuid}:${obj.visit.uuid}`;\n    if (!acc[patientOuProgram]) {\n      acc[patientOuProgram] = [];\n    }\n    acc[patientOuProgram].push(obj);\n    return acc;\n  }, {});\n\n  state.eventsMapping = Object.entries(pairedEncounters).map(\n    ([patientKey, patientEncounters]) => {\n      const [orgUnit, program, programStage, patientUuid] =\n        patientKey.split(\":\");\n\n      const tei = state.TEIs[patientUuid];\n\n      const dataValues = patientEncounters\n        .map((encounter) => {\n          const form = state.formMaps[encounter.form.uuid];\n          if (!form?.dataValueMap) {\n            return null;\n          }\n          return buildDataValues(encounter, tei, {\n            optsMap: state.optsMap,\n            optionSetKey: state.optionSetKey,\n            form,\n            f08Form,\n            f09Form,\n            f23Form,\n            f24Form,\n            f25Form,\n            f26Form,\n            f27Form,\n            f28Form,\n            f41Form,\n            f42Form,\n            f43Form,\n          });\n        })\n        .flat()\n        .filter((d) => d.value);\n\n      const latestEncounter = patientEncounters.sort(\n        (a, b) => new Date(b.encounterDatetime) - new Date(a.encounterDatetime)\n      )[0];\n\n      const eventDate = latestEncounter?.encounterDatetime.replace(\"+0000\", \"\");\n\n      const patientNumber = tei?.attributes?.find(\n        (a) => a.code === \"patient_number\"\n      ).value;\n\n      const visitUuid = latestEncounter.visit.uuid;\n      const event = state.eventsByPatient[`${orgUnit}-${program}`]?.[\n        patientNumber\n      ]?.find((e) => e.visitUuid === visitUuid)?.event;\n      if (event) {\n        console.log(\"Event found:\", event);\n      }\n      return {\n        event,\n        program,\n        orgUnit,\n        occurredAt: eventDate,\n        programStage,\n        dataValues,\n        trackedEntity: tei.trackedEntity,\n      };\n    }\n  );\n\n  return state;\n});\n",
          "adaptor": "@openfn/language-common@2.1.1",
          "project_credential_id": null
        },
        "Get-Patients": {
          "id": "51485ee3-05c2-4690-8da6-9b962b6c19d5",
          "name": "Get Patients",
          "body": "function removeLinks(data) {\n  if (Array.isArray(data)) {\n    return data.map(removeLinks);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const { links, ...rest } = data;\n    return Object.fromEntries(\n      Object.entries(rest).map(([key, value]) => [key, removeLinks(value)])\n    );\n  }\n\n  return data;\n}\n\nfunction removeNulls(data) {\n  if (Array.isArray(data)) {\n    return data.filter((item) => item !== null).map(removeNulls);\n  }\n\n  if (typeof data === \"object\" && data !== null) {\n    const result = {};\n    for (const [key, value] of Object.entries(data)) {\n      if (value !== null) {\n        result[key] = removeNulls(value);\n      }\n    }\n    return result;\n  }\n\n  return data;\n}\ncursor($.lastRunDateTime || $.manualCursor || \"2025-03-20T06:01:24.000Z\");\n\ncursor(\"today\", {\n  key: \"lastRunDateTime\",\n  format: (c) => dateFns.format(new Date(c), \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\"),\n});\n\nsearchPatient({\n  q: $.msfId || \"IQ\",\n  v: \"full\",\n  limit: \"100\",\n});\n\nfn((state) => {\n  const { cursor, data, lastRunDateTime } = state;\n  console.log(\"Filtering patients since cursor:\", cursor);\n\n  state.patients = data.results\n    .filter(({ auditInfo }) => {\n      const lastModified = auditInfo?.dateChanged || auditInfo?.dateCreated;\n      return lastModified > cursor;\n    })\n    .map((p) => {\n      const { uuid, auditInfo, identifiers, person } = removeLinks(\n        removeNulls(p)\n      );\n      const { dateCreated } = auditInfo;\n      const { age, birthdate, gender, names, addresses, attributes } = person;\n\n      return {\n        uuid,\n        person: {\n          age,\n          birthdate,\n          gender,\n          names,\n          addresses: [addresses.find((a) => a.cityVillage)],\n          attributes,\n        },\n        identifiers,\n        auditInfo: { dateCreated },\n      };\n    });\n  state.searchPatientUuids = state.patients.map((p) => p.uuid);\n  console.log(\"# of patients to sync to dhis2 ::\", state.patients.length);\n\n  return state;\n});\n\n// Fetch all encounters\nhttp\n  .get(\"/ws/fhir2/R4/Encounter\", {\n    query: { _count: 100, _lastUpdated: `ge${$.cursor}` },\n  })\n  .then((state) => {\n    const { link, total } = state.data;\n    state.nextUrl = link\n      .find((l) => l.relation === \"next\")\n      ?.url.replace(/(_count=)\\d+/, `$1${total}`)\n      .split(\"/openmrs\")[1];\n\n    state.allResponse = state.data;\n    return state;\n  });\n\nfnIf(\n  $.nextUrl,\n  http.get($.nextUrl).then((state) => {\n    console.log(`Fetched ${state.data.entry.length} remaining encounters`);\n    delete state.allResponse.link;\n    state.allResponse.entry.push(...state.data.entry);\n    return state;\n  })\n);\n\nfn((state) => {\n  console.log(\n    \"Total # of encounters fetched: \",\n    state.allResponse?.entry?.length\n  );\n\n  const uuids = [\n    ...new Set(\n      state.allResponse?.entry?.map((p) =>\n        p.resource?.subject?.reference?.replace(\"Patient/\", \"\")\n      )\n    ),\n  ];\n  state.encounterPatientUuids = [...new Set(uuids)];\n\n  return state;\n});\n\nfn((state) => {\n  const {\n    cursor,\n    lastRunDateTime,\n    patients,\n    searchPatientUuids,\n    encounterPatientUuids,\n  } = state;\n\n  const onlyInSearchPatient = searchPatientUuids.filter(\n    (id) => !encounterPatientUuids.includes(id)\n  );\n\n  const onlyInR4Encounter = encounterPatientUuids.filter(\n    (id) => !searchPatientUuids.includes(id)\n  );\n  const inbothResults = searchPatientUuids.filter((id) =>\n    encounterPatientUuids.includes(id)\n  );\n  const patientUuids = [\n    ...new Set([...searchPatientUuids, ...encounterPatientUuids]),\n  ];\n\n  console.log(\"inbothResults\", inbothResults.length);\n  console.log(\"patient-search-array\", onlyInSearchPatient.length);\n  console.log(\"r4-encounter-array\", onlyInR4Encounter.length);\n  console.log(\"combined uuids\", patientUuids.length);\n\n  return { cursor, lastRunDateTime, patients, patientUuids };\n});\n",
          "adaptor": "@openfn/language-openmrs@4.3.0",
          "project_credential_id": "efd2a233-caf8-4346-bc0c-6a25c24e1a08"
        },
        "Upsert-TEIs": {
          "id": "f628007a-5a2c-463f-9de3-d2e465f95aae",
          "name": "Upsert TEIs",
          "body": "const buildTeiMapping = (omrsPatient, patientTei, mappingConfig) => {\n  const genderMap = {\n    M: \"male\",\n    O: \"unknown\",\n    F: \"female\",\n    U: \"unknown\",\n  };\n  const {\n    orgUnit,\n    program,\n    optsMap,\n    formMaps,\n    placeOflivingMap,\n    patientProgramStage,\n    dhis2PatientNumber,\n    openmrsAutoId,\n  } = mappingConfig;\n\n  const enrolledAt = omrsPatient.auditInfo.dateCreated.substring(0, 10);\n  const findIdentifierByUuid = (identifiers, targetUuid) =>\n    identifiers.find((i) => i.identifierType.uuid === targetUuid)?.identifier;\n\n  const findOptsUuid = (uuid) =>\n    omrsPatient.person.attributes.find((a) => a.attributeType.uuid === uuid)\n      ?.value?.uuid ||\n    omrsPatient.person.attributes.find((a) => a.attributeType.uuid === uuid)\n      ?.value;\n\n  const findOptCode = (optUuid) =>\n    optsMap.find((o) => o[\"value.uuid - External ID\"] === optUuid)?.[\n      \"DHIS2 Option Code\"\n    ];\n\n  const patientMap = formMaps.patient.dataValueMap;\n  const statusAttrMaps = Object.keys(patientMap).map((d) => {\n    const optUid = findOptsUuid(patientMap[d]);\n    return {\n      attribute: d,\n      value: findOptCode(optUid) || optUid,\n    };\n  });\n\n  const standardAttr = [\n    {\n      attribute: \"fa7uwpCKIwa\",\n      value: omrsPatient.person?.names[0]?.givenName,\n    },\n    {\n      attribute: \"Jt9BhFZkvP2\",\n      value: omrsPatient.person?.names[0]?.familyName,\n    },\n    {\n      attribute: \"P4wdYGkldeG\", //DHIS2 ID ==> \"Patient Number\"\n      value:\n        findIdentifierByUuid(omrsPatient.identifiers, dhis2PatientNumber) ||\n        findIdentifierByUuid(omrsPatient.identifiers, openmrsAutoId), //map OMRS ID if no DHIS2 id\n    },\n    {\n      attribute: \"ZBoxuExmxcZ\", //MSF ID ==> \"OpenMRS Patient Number\"\n      value: findIdentifierByUuid(omrsPatient.identifiers, openmrsAutoId),\n    },\n    {\n      attribute: \"AYbfTPYMNJH\", //\"OpenMRS Patient UID\"\n      value: omrsPatient.uuid,\n    },\n\n    {\n      attribute: \"T1iX2NuPyqS\",\n      value: omrsPatient.person.age,\n    },\n    {\n      attribute: \"WDp4nVor9Z7\",\n      value: omrsPatient.person.birthdate?.slice(0, 10),\n    },\n    {\n      attribute: \"rBtrjV1Mqkz\", //Place of living\n      value: placeOflivingMap[omrsPatient.person?.addresses[0]?.cityVillage],\n    },\n  ];\n\n  //filter out attributes that don't have a value from dhis2\n  const filteredAttr = standardAttr.filter((a) => a.value);\n  const filteredStatusAttr = statusAttrMaps.filter((a) => a.value);\n\n  const payload = {\n    program,\n    orgUnit,\n    attributes: [...filteredAttr, ...filteredStatusAttr],\n  };\n  // console.log('mapped dhis2 payloads:: ', JSON.stringify(payload, null, 2));\n\n  if (!patientTei) {\n    payload.trackedEntityType = \"cHlzCA2MuEF\";\n    const enrollments = [\n      {\n        orgUnit,\n        program,\n        enrolledAt,\n        programStage: patientProgramStage, //'MdTtRixaC1B',\n      },\n    ];\n    payload.attributes.push({\n      attribute: \"qptKDiv9uPl\",\n      value: genderMap[omrsPatient.person.gender],\n    });\n    console.log(\"create enrollment\");\n    payload.enrollments = enrollments;\n  } else {\n    payload.trackedEntity = patientTei.trackedEntity;\n    payload.trackedEntityType = patientTei.trackedEntityType;\n  }\n\n  return payload;\n};\n\nconst delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n\nget(\"tracker/trackedEntities\", {\n  orgUnit: $.orgUnit,\n  filter: (state) => [\n    `AYbfTPYMNJH:IN:${state.patients.map((patient) => patient.uuid).join(\";\")}`,\n  ],\n  program: $.program,\n});\n\nfn((state) => {\n  const findTeiByUuid = (patientUuid) => {\n    return state.data.instances.find((tei) => {\n      return (\n        tei.attributes.find(\n          (attribute) => attribute.attribute === \"AYbfTPYMNJH\"\n        )?.value === patientUuid\n      );\n    });\n  };\n\n  state.patientsMapping = state.patients.map((patient) => {\n    const patientTei = findTeiByUuid(patient.uuid);\n\n    return buildTeiMapping(patient, patientTei, {\n      placeOflivingMap: state.placeOflivingMap,\n      orgUnit: state.orgUnit,\n      program: state.program,\n      patientProgramStage: state.patientProgramStage,\n      formMaps: state.formMaps,\n      optsMap: state.optsMap,\n      dhis2PatientNumber: state.dhis2PatientNumber,\n      openmrsAutoId: state.openmrsAutoId,\n    });\n  });\n\n  return state;\n});\n\n// Bulk upsert\ncreate(\n  \"tracker\",\n  { trackedEntities: $.patientsMapping },\n  {\n    params: {\n      atomicMode: \"ALL\",\n      async: false,\n    },\n  }\n);\n\nfn((state) => {\n  const {\n    data,\n    response,\n    references,\n    patients,\n    patientsUpsert,\n    placeOflivingMap,\n    identifiers,\n    ...next\n  } = state;\n  next.patientUuids = patients.map((p) => p.uuid);\n  return next;\n});\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Get-TEIs-and-Map-Answers": {
          "id": "7a1831ef-a388-4565-bf44-d603fdd19871",
          "name": "Get TEIs and Map Answers",
          "body": "const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n\nconst teiByPatientUuid = (patientUuid, teis) => {\n  return teis.find((tei) => {\n    const omrsPatientUuid = tei.attributes.find(\n      ({ attribute }) => attribute === \"AYbfTPYMNJH\"\n    )?.value;\n\n    return omrsPatientUuid === patientUuid;\n  });\n};\n\nget(\"tracker/trackedEntities\", {\n  orgUnit: $.orgUnit,\n  program: $.program,\n  filter: (state) => [\n    `AYbfTPYMNJH:IN:${state.encountersPatientUuids.join(\";\")}`,\n  ],\n  fields: \"*\",\n});\n\nfn((state) => {\n  state.TEIs ??= {};\n  state.encountersPatientUuids.forEach((patientUuid) => {\n    const tei = teiByPatientUuid(patientUuid, state.data.instances);\n    if (tei?.trackedEntity) {\n      console.log(\"Parent TEI found:\", tei.trackedEntity);\n\n      state.TEIs[patientUuid] = {\n        ...tei,\n        enrollment: tei.enrollments[0]?.enrollment,\n      };\n    } else {\n      console.log(\"Parent TEI Not Found for Patient:\", patientUuid);\n    }\n  });\n\n  return state;\n});\n\nfn((state) => {\n  state.ouProgramTeis = state.latestEncountersByVisit.reduce((acc, obj) => {\n    const formUuid = obj.form.uuid;\n    // const patientUuid = obj.patient.uuid;\n    const patientNumber = obj.patient.display.split(\" - \")[0];\n    const orgUnit = state.formMaps[formUuid].orgUnit;\n    const program = state.formMaps[formUuid].programId;\n    const key = `${orgUnit}-${program}`;\n    if (!acc[key]) {\n      acc[key] = {\n        orgUnit,\n        program,\n        patientNumbers: [patientNumber],\n      };\n    }\n    if (!acc[key].patientNumbers.includes(patientNumber)) {\n      acc[key].patientNumbers.push(patientNumber);\n    }\n\n    return acc;\n  }, {});\n\n  return state;\n});\n\neach(\n  (state) => Object.values(state.ouProgramTeis),\n  get(\"tracker/events\", (state) => {\n    const { orgUnit, program } = state.data;\n    return {\n      orgUnit,\n      program,\n      fields: \"*\",\n    };\n  }).then((state) => {\n    const { orgUnit, program, patientNumbers } = state.references.at(-1);\n    state.eventsByPatient ??= {};\n    const grouped = state.data.instances?.reduce((acc, event) => {\n      const patientNumber = event.dataValues.find(\n        (dv) => dv.dataElement === \"Pi1zytYdq6l\" ||\n                dv.dataElement === \"fnH6H3biOkE\" ||\n                dv.dataElement === \"kcSuQKfU5Zo\" ||\n                dv.dataElement === \"ci9C72RjN8Z\"\n      )?.value;\n      if (!patientNumber || !patientNumbers.includes(patientNumber)) {\n        return acc;\n      }\n      const visitUuid = event.dataValues.find(\n        (dv) => dv.dataElement === \"rbFVBI2N6Ex\"\n      )?.value;\n\n      if (!acc[patientNumber]) {\n        acc[patientNumber] = [];\n      }\n      acc[patientNumber].push({\n        event: event.event,\n        occuredAt: event.occuredAt,\n        visitUuid\n      });\n      return acc;\n    }, {});\n    console.log(`Processing ${state.data.instances?.length || 0} events for ${orgUnit}-${program}`);\n    console.log(\"Grouped events by patient:\", Object.keys(grouped).length, \"patients\");\n    state.eventsByPatient[`${orgUnit}-${program}`] = grouped;\n    return state;\n  })\n);\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        },
        "Get-Tie": {
          "id": "47c1397c-a146-4511-bada-7ab0bd07b123",
          "name": "Get Tie",
          "body": "const delay = ms => new Promise(resolve => setTimeout(resolve, ms));\n\nconst patientUid = \"d464433d-41d5-482f-808c-7fe364847352\"\n//TODO: Group the encounters by patient and then get the TEI for each patient\nget('tracker/trackedEntities', state => ({\n  orgUnit: \"sUpt0j2GmBD\",\n  program: \"dWdzxMuKa8Z\",\n  // orgUnit: state.formMaps[state.data.form.uuid].orgUnit, //TODO: the org unit and program should be fetched from fromMap by mapping encounter.form.uuid\n  // program: state.formMaps[state.data.form.uuid].programId, //TODO: the org unit and program should be fetched from fromMap by mapping encounter.form.uuid\n  filter: [`AYbfTPYMNJH:Eq:${patientUid}`],\n  fields: '*,enrollments[*],enrollments[events[*]], attributes[*]',\n})).then(async state => {\n  \n  console.log(patientUid, 'Encounter patient uuid');\n\n  const { trackedEntity, enrollments, attributes } = state.data?.instances?.[0] || {};\n  if (trackedEntity && enrollments) {\n    state.TEIs ??= {};\n    state.TEIs[patientUid] = {\n      trackedEntity,\n      events: enrollments[0]?.events,\n      enrollment: enrollments[0]?.enrollment,\n      attributes\n    };\n  }\n\n  await delay(2000);\n  return state;\n})\n",
          "adaptor": "@openfn/language-dhis2@5.0.1",
          "project_credential_id": "448e46cd-482d-4cb5-88f9-b413cdd7ff3f"
        }
      },
      "edges": {
        "Custom-Logic-for-Events->Create-Events": {
          "enabled": true,
          "id": "168e2969-4f85-4c05-843c-445ca7102086",
          "target_job_id": "2d668d2e-c513-4b58-88bb-8a2d3261d9a2",
          "source_job_id": "782cdfc3-9357-4763-8681-798ae1b29fd1",
          "condition_type": "js_expression",
          "condition_label": "has-events",
          "condition_expression": "state?.eventsMapping?.length > 0 && !state.errors && !state.testMode\n"
        },
        "Get-Mappings-from-Collection->Get-Encounters": {
          "enabled": true,
          "id": "d9d6c1fb-627e-491e-88b1-ed2575e77de3",
          "target_job_id": "2b1e02ae-7546-480a-86cc-77a815f61256",
          "source_job_id": "0acf6701-064d-412d-8672-db507c9e95c6",
          "condition_type": "js_expression",
          "condition_label": "has-no-patients",
          "condition_expression": "!state.errors && state.patients.length === 0\n"
        },
        "Upsert-TEIs->Get-Encounters": {
          "enabled": true,
          "id": "1d37cfc8-1a71-4cc8-809d-583d6d8b8fca",
          "target_job_id": "2b1e02ae-7546-480a-86cc-77a815f61256",
          "source_job_id": "f628007a-5a2c-463f-9de3-d2e465f95aae",
          "condition_type": "js_expression",
          "condition_label": "has-patient-uuids",
          "condition_expression": "state.patientUuids.length > 0 && !state.errors\n"
        },
        "Get-Patients->Get-Mappings-from-Collection": {
          "enabled": true,
          "id": "15dc93e4-fb96-4cc5-b0c3-c0bd544bdc6d",
          "target_job_id": "0acf6701-064d-412d-8672-db507c9e95c6",
          "source_job_id": "51485ee3-05c2-4690-8da6-9b962b6c19d5",
          "condition_type": "on_job_success"
        },
        "Get-TEIs-and-Map-Answers->Custom-Logic-for-Events": {
          "enabled": true,
          "id": "9eb6f99d-434c-4b47-ab4b-058a5930435c",
          "target_job_id": "782cdfc3-9357-4763-8681-798ae1b29fd1",
          "source_job_id": "7a1831ef-a388-4565-bf44-d603fdd19871",
          "condition_type": "js_expression",
          "condition_label": "has-teis",
          "condition_expression": "state.TEIs && !state.errors\n"
        },
        "Get-Encounters->Get-TEIs-and-Map-Answers": {
          "enabled": true,
          "id": "bd5834d4-b481-47f0-b497-c56dbd05ed03",
          "target_job_id": "7a1831ef-a388-4565-bf44-d603fdd19871",
          "source_job_id": "2b1e02ae-7546-480a-86cc-77a815f61256",
          "condition_type": "js_expression",
          "condition_label": "has-encounters",
          "condition_expression": "!state.errors && state?.encounters?.length > 0\n"
        },
        "cron->Get-Patients": {
          "enabled": true,
          "id": "d681f4f9-4e4f-415f-a52c-a6fcd9f2740b",
          "target_job_id": "51485ee3-05c2-4690-8da6-9b962b6c19d5",
          "source_trigger_id": "cd9ea573-fb86-4ec4-8c39-200c7de22dfb",
          "condition_type": "always"
        },
        "Get-Mappings-from-Collection->Upsert-TEIs": {
          "enabled": true,
          "id": "7b001148-c273-49f5-9582-09979cbd4ca9",
          "target_job_id": "f628007a-5a2c-463f-9de3-d2e465f95aae",
          "source_job_id": "0acf6701-064d-412d-8672-db507c9e95c6",
          "condition_type": "js_expression",
          "condition_label": "has-patients",
          "condition_expression": "state.patients.length > 0 && !state.errors\n"
        },
        "Get-Tie->Custom-Logic-for-Events": {
          "enabled": true,
          "id": "80f9eb77-8bc4-4557-8c9b-907ab7408473",
          "target_job_id": "782cdfc3-9357-4763-8681-798ae1b29fd1",
          "source_job_id": "47c1397c-a146-4511-bada-7ab0bd07b123",
          "condition_type": "js_expression",
          "condition_label": "test-mode",
          "condition_expression": "state.testMode\n"
        }
      }
    }
  },
  "allow_support_access": false,
  "requires_mfa": false
}